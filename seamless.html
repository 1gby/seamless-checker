<!-- Rudeboy Pattern Checker - P.I.M.P PRODUCTION - DARK MODE -->

<!-- UPDATED: Full Dark Mode with Black, Purple & Green Theme -->

<!DOCTYPE html>

<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
<meta name="theme-color" content="#000000">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

<link rel="apple-touch-icon" sizes="180x180" href="https://raw.githubusercontent.com/1gby/seamless-checker/main/assets/icons/nova.png">
<link rel="apple-touch-icon" sizes="152x152" href="https://raw.githubusercontent.com/1gby/seamless-checker/main/assets/icons/nova.png">
<link rel="apple-touch-icon" sizes="120x120" href="https://raw.githubusercontent.com/1gby/seamless-checker/main/assets/icons/nova.png">
<link rel="apple-touch-icon" href="https://raw.githubusercontent.com/1gby/seamless-checker/main/assets/icons/nova.png">
<meta name="apple-mobile-web-app-title" content="Rudeboy Pattern">
<style>
/* ==================== GLOBAL RESET ==================== */
:root{
  color-scheme:dark;
  --color-black: #000000;
  --color-purple: #764ba2;
  --color-green: #10b981;
  --color-dark-bg: rgba(0, 0, 0, 0.95);
  --color-glass: rgba(0, 0, 0, 0.8);
  --color-text-primary: #ffffff;
  --color-text-secondary: #cccccc;
  --color-text-muted: #999999;
}
*{box-sizing:border-box;-webkit-tap-highlight-color:transparent}
html,body{margin:0;padding:0;width:100%;height:100%;overflow-x:hidden;background:var(--color-black)}

/* ==================== BODY & CONTAINER ==================== */
body{
font-family:-apple-system,BlinkMacSystemFont,‚ÄòSegoe UI‚Äô,Roboto,‚ÄòHelvetica Neue‚Äô,Arial,sans-serif;
background:linear-gradient(135deg,#000000 0%,#0a0a0a 100%);
color:var(‚Äìcolor-text-primary);
min-height:100vh;
padding-top:env(safe-area-inset-top);
padding-bottom:env(safe-area-inset-bottom);
touch-action:pan-x pan-y;
}

/* Standalone PWA Mode Enhancements */
body.standalone-mode #header{
background:var(‚Äìcolor-glass);
backdrop-filter:blur(60px) saturate(200%);
-webkit-backdrop-filter:blur(60px) saturate(200%);
border-bottom:1px solid rgba(16,185,129,0.3);
}

body.standalone-mode .title::after{
content:‚Äô PWA‚Äô;
font-size:0.6em;
opacity:0.5;
margin-left:0.3rem;
}

#container{display:flex;flex-direction:column;min-height:100vh}

/* ==================== HEADER ==================== */
#header{
padding:1.5rem 2rem;
background:var(‚Äìcolor-glass);
backdrop-filter:blur(40px) saturate(180%);
-webkit-backdrop-filter:blur(40px) saturate(180%);
border-bottom:1px solid rgba(118,75,162,0.4);
box-shadow:0 8px 32px rgba(0,0,0,0.9),inset 0 1px 0 rgba(255,255,255,0.05);
display:flex;
align-items:center;
justify-content:space-between;
gap:2rem;
flex-wrap:wrap;
}

.logo-section{display:flex;align-items:center;gap:1.5rem}

#logo{
height:42px;
width:auto;
cursor:pointer;
transition:transform 0.3s,filter 0.3s;
filter:drop-shadow(0 0 0px rgba(16,185,129,0));
animation:pulse 2s ease-in-out infinite;
}
/* Logo pulsing glow animation */
@keyframes pulse{
0%,100%{filter:drop-shadow(0 0 0px rgba(16,185,129,0))}
50%{filter:drop-shadow(0 0 6px rgba(16,185,129,1)) drop-shadow(0 0 12px rgba(16,185,129,1))}
}
#logo:hover{transform:scale(1.05)}
#logo:active{animation:glow-pulse 0.4s ease-out;transform:scale(0.98)}
@keyframes glow-pulse{
0%{filter:drop-shadow(0 0 0px rgba(16,185,129,0))}
50%{filter:drop-shadow(0 0 20px rgba(16,185,129,1)) drop-shadow(0 0 30px rgba(16,185,129,0.8))}
100%{filter:drop-shadow(0 0 0px rgba(16,185,129,0))}
}

.title{
font-size:1.5rem;
font-weight:700;
background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);
-webkit-background-clip:text;
-webkit-text-fill-color:transparent;
background-clip:text;
margin:0;
}

.header-buttons{
display:flex;
align-items:center;
gap:0.75rem;
flex-wrap:nowrap;
justify-content:center;
width:100%;
max-width:600px;
}

.file-input-wrapper{position:relative;display:flex;flex:1}
.file-input-wrapper input[type=file]{
position:absolute;
left:-9999px;
opacity:0;
pointer-events:none;
}

/* Header button styles with glassmorphism effect */
.upload-btn,.export-btn-header,.sample-btn{
padding:0.85rem 1rem;
min-height:52px;
color:white;
border:none;
border-radius:16px;
font-size:0.9rem;
font-weight:600;
cursor:pointer;
transition:all 0.3s;
width:100%;
white-space:nowrap;
text-align:center;
flex:1;
display:flex;
align-items:center;
justify-content:center;
background:var(‚Äìcolor-glass);
backdrop-filter:blur(40px) saturate(180%) brightness(1.1);
-webkit-backdrop-filter:blur(40px) saturate(180%) brightness(1.1);
border:1px solid rgba(118,75,162,0.4);
box-shadow:0 8px 32px rgba(0,0,0,0.8),inset 0 2px 0 rgba(255,255,255,0.1),inset 0 -2px 0 rgba(0,0,0,0.5);
position:relative;
overflow:hidden;
}

/* Button hover effect overlay */
.upload-btn::before,.export-btn-header::before,.sample-btn::before{
content:‚Äô‚Äô;
position:absolute;
top:-50%;
left:-50%;
width:200%;
height:200%;
background:radial-gradient(circle,rgba(255,255,255,0.05) 0%,transparent 70%);
opacity:0;
transition:opacity 0.3s;
}

.upload-btn:hover::before,.export-btn-header:hover::before,.sample-btn:hover::before{
opacity:1;
}

/* Upload button with purple glow */
.upload-btn{
box-shadow:0 8px 32px rgba(0,0,0,0.8),0 0 20px rgba(118,75,162,0.6),inset 0 2px 0 rgba(255,255,255,0.1),inset 0 -2px 0 rgba(0,0,0,0.5);
}
.upload-btn:hover{
transform:translateY(-2px);
background:rgba(0,0,0,0.9);
box-shadow:0 12px 40px rgba(0,0,0,0.9),0 0 25px rgba(118,75,162,0.8),inset 0 2px 0 rgba(255,255,255,0.15),inset 0 -2px 0 rgba(0,0,0,0.5);
}
.upload-btn:active{
transform:translateY(0);
box-shadow:0 4px 16px rgba(0,0,0,0.8),0 0 30px rgba(118,75,162,1),inset 0 2px 0 rgba(255,255,255,0.1),inset 0 -2px 0 rgba(0,0,0,0.6);
}

/* Sample button with green glow */
.sample-btn{
box-shadow:0 8px 32px rgba(0,0,0,0.8),0 0 20px rgba(16,185,129,0.6),inset 0 2px 0 rgba(255,255,255,0.1),inset 0 -2px 0 rgba(0,0,0,0.5);
}
.sample-btn:hover{
transform:translateY(-2px);
background:rgba(0,0,0,0.9);
box-shadow:0 12px 40px rgba(0,0,0,0.9),0 0 25px rgba(16,185,129,0.8),inset 0 2px 0 rgba(255,255,255,0.15),inset 0 -2px 0 rgba(0,0,0,0.5);
}
.sample-btn:active{
transform:translateY(0);
box-shadow:0 4px 16px rgba(0,0,0,0.8),0 0 30px rgba(16,185,129,1),inset 0 2px 0 rgba(255,255,255,0.1),inset 0 -2px 0 rgba(0,0,0,0.6);
}

/* Export button with purple glow */
.export-btn-header{
box-shadow:0 8px 32px rgba(0,0,0,0.8),0 0 20px rgba(118,75,162,0.6),inset 0 2px 0 rgba(255,255,255,0.1),inset 0 -2px 0 rgba(0,0,0,0.5);
}
.export-btn-header:hover{
transform:translateY(-2px);
background:rgba(0,0,0,0.9);
box-shadow:0 12px 40px rgba(0,0,0,0.9),0 0 25px rgba(118,75,162,0.8),inset 0 2px 0 rgba(255,255,255,0.15),inset 0 -2px 0 rgba(0,0,0,0.5);
}
.export-btn-header:active{
transform:translateY(0);
box-shadow:0 4px 16px rgba(0,0,0,0.8),0 0 30px rgba(118,75,162,1),inset 0 2px 0 rgba(255,255,255,0.1),inset 0 -2px 0 rgba(0,0,0,0.6);
}
.export-btn-header:disabled{
opacity:0.4;
cursor:not-allowed;
transform:none;
box-shadow:0 8px 32px rgba(0,0,0,0.8),inset 0 2px 0 rgba(255,255,255,0.1),inset 0 -2px 0 rgba(0,0,0,0.5);
}

/* ==================== CANVAS AREA ==================== */
#canvas-wrapper{
flex:1;
display:flex;
align-items:center;
justify-content:center;
padding:2rem;
position:relative;
touch-action:none;
}

#canvas{
max-width:1200px;
width:100%;
aspect-ratio:1;
border-radius:20px;
box-shadow:0 20px 60px rgba(0,0,0,0.9);
cursor:pointer;
transition:all 0.3s;
background:rgba(0,0,0,0.5);
backdrop-filter:blur(20px);
-webkit-backdrop-filter:blur(20px);
border:1px solid rgba(118,75,162,0.3);
touch-action:none;
}
#canvas.has-image{cursor:grab}
#canvas.has-image:active{cursor:grabbing}
#canvas:hover{box-shadow:0 25px 70px rgba(0,0,0,1)}

/* Empty state when no image loaded */
.empty-state{
position:absolute;
top:50%;
left:50%;
transform:translate(-50%,-50%);
text-align:center;
pointer-events:none;
opacity:0;
transition:opacity 0.3s;
}
.empty-state.visible{opacity:1}
.empty-state-icon{font-size:4rem;margin-bottom:1rem;opacity:0.6}
.empty-state-text{font-size:1.25rem;font-weight:600;margin-bottom:0.5rem;color:var(‚Äìcolor-text-secondary)}
.empty-state-subtext{font-size:0.95rem;color:var(‚Äìcolor-text-muted)}

/* ==================== EXPORT MODAL ==================== */
.export-modal{
position:fixed;
top:0;
left:0;
right:0;
bottom:0;
background:rgba(0,0,0,0.95);
backdrop-filter:blur(30px);
-webkit-backdrop-filter:blur(30px);
display:none;
align-items:center;
justify-content:center;
z-index:9999;
opacity:0;
transition:opacity 0.3s;
padding:2rem;
}
.export-modal.visible{display:flex;opacity:1}

.export-modal-content{
background:var(‚Äìcolor-glass);
backdrop-filter:blur(40px) saturate(180%) brightness(1.1);
-webkit-backdrop-filter:blur(40px) saturate(180%) brightness(1.1);
border-radius:20px;
border:1px solid rgba(118,75,162,0.3);
box-shadow:0 8px 32px rgba(0,0,0,0.9),inset 0 2px 0 rgba(255,255,255,0.05),inset 0 -2px 0 rgba(0,0,0,0.5);
padding:2rem;
max-width:400px;
width:100%;
}

.export-modal-title{
font-size:1.5rem;
font-weight:700;
background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);
-webkit-background-clip:text;
-webkit-text-fill-color:transparent;
background-clip:text;
margin:0 0 1.5rem 0;
text-align:center;
}

.export-options{
display:flex;
flex-direction:column;
gap:1rem;
margin-bottom:1.5rem;
}

.export-option{
display:flex;
flex-direction:column;
gap:0.5rem;
}

.export-option-label{
font-size:0.9rem;
font-weight:600;
color:var(‚Äìcolor-text-secondary);
}

.export-option select,
.export-option input{
padding:0.75rem 1rem;
font-size:0.95rem;
border-radius:12px;
background:rgba(0,0,0,0.6);
backdrop-filter:blur(40px) saturate(180%) brightness(1.1);
-webkit-backdrop-filter:blur(40px) saturate(180%) brightness(1.1);
border:1px solid rgba(118,75,162,0.3);
box-shadow:0 4px 20px rgba(0,0,0,0.6),inset 0 2px 0 rgba(255,255,255,0.05),inset 0 -2px 0 rgba(0,0,0,0.3);
color:var(‚Äìcolor-text-primary);
font-family:inherit;
width:100%;
}

.export-buttons{
display:flex;
gap:1rem;
}

.export-btn-confirm,
.export-btn-cancel{
flex:1;
padding:0.85rem 1rem;
border-radius:12px;
font-size:0.95rem;
font-weight:600;
cursor:pointer;
transition:all 0.3s;
border:none;
background:rgba(0,0,0,0.6);
backdrop-filter:blur(40px) saturate(180%) brightness(1.1);
-webkit-backdrop-filter:blur(40px) saturate(180%) brightness(1.1);
border:1px solid rgba(118,75,162,0.3);
box-shadow:0 4px 20px rgba(0,0,0,0.6),inset 0 2px 0 rgba(255,255,255,0.05),inset 0 -2px 0 rgba(0,0,0,0.3);
color:var(‚Äìcolor-text-primary);
}

.export-btn-confirm{
box-shadow:0 4px 20px rgba(0,0,0,0.6),0 0 20px rgba(16,185,129,0.6),inset 0 2px 0 rgba(255,255,255,0.05),inset 0 -2px 0 rgba(0,0,0,0.3);
}

.export-btn-confirm:hover{
transform:translateY(-2px);
box-shadow:0 6px 24px rgba(0,0,0,0.8),0 0 25px rgba(16,185,129,0.8),inset 0 2px 0 rgba(255,255,255,0.1),inset 0 -2px 0 rgba(0,0,0,0.3);
}

.export-btn-cancel{
box-shadow:0 4px 20px rgba(0,0,0,0.6),0 0 20px rgba(239,68,68,0.6),inset 0 2px 0 rgba(255,255,255,0.05),inset 0 -2px 0 rgba(0,0,0,0.3);
}

.export-btn-cancel:hover{
transform:translateY(-2px);
box-shadow:0 6px 24px rgba(0,0,0,0.8),0 0 25px rgba(239,68,68,0.8),inset 0 2px 0 rgba(255,255,255,0.1),inset 0 -2px 0 rgba(0,0,0,0.3);
}

/* ==================== LOADING OVERLAY ==================== */
.loading-overlay{
position:fixed;
top:0;
left:0;
right:0;
bottom:0;
background:rgba(0,0,0,0.98);
backdrop-filter:blur(30px);
-webkit-backdrop-filter:blur(30px);
display:none;
align-items:center;
justify-content:center;
flex-direction:column;
z-index:10000;
opacity:0;
transition:opacity 0.3s;
}
.loading-overlay.visible{display:flex;opacity:1}

.loading-logo{
width:120px;
height:120px;
opacity:0.8;
animation:spin-glow 3s linear infinite;
}
/* Loading logo spin animation with color change */
@keyframes spin-glow{
0%{
transform:rotate(0deg);
filter:drop-shadow(0 0 20px rgba(16,185,129,1)) drop-shadow(0 0 40px rgba(16,185,129,0.8));
}
50%{
transform:rotate(360deg);
filter:drop-shadow(0 0 20px rgba(16,185,129,1)) drop-shadow(0 0 40px rgba(16,185,129,0.8));
}
51%{
filter:drop-shadow(0 0 20px rgba(118,75,162,1)) drop-shadow(0 0 40px rgba(118,75,162,0.8));
}
100%{
transform:rotate(720deg);
filter:drop-shadow(0 0 20px rgba(118,75,162,1)) drop-shadow(0 0 40px rgba(118,75,162,0.8));
}
}

.loading-text{
font-size:1.2rem;
font-weight:600;
color:var(‚Äìcolor-text-primary);
margin-top:1.5rem;
text-align:center;
opacity:0.9;
}

.loading-subtext{
font-size:0.9rem;
color:var(‚Äìcolor-text-muted);
margin-top:0.5rem;
text-align:center;
display:none;
}

.loading-subtext:not(:empty){
display:block;
}

/* Progress bar for loading states */
.progress-bar-container{
width:280px;
height:6px;
background:rgba(0,0,0,0.8);
border-radius:10px;
margin:1.5rem auto 0;
overflow:hidden;
display:none;
border:1px solid rgba(118,75,162,0.3);
}

.progress-bar-container.visible{
display:block;
}

.progress-bar-fill{
height:100%;
width:0%;
background:linear-gradient(90deg,var(‚Äìcolor-green) 0%,var(‚Äìcolor-purple) 100%);
border-radius:10px;
transition:width 0.3s ease;
box-shadow:0 0 10px rgba(16,185,129,0.6);
}
/* ==================== CONTROLS SECTION ==================== */
#controls{
padding:2rem;
background:var(‚Äìcolor-glass);
backdrop-filter:blur(40px) saturate(180%);
-webkit-backdrop-filter:blur(40px) saturate(180%);
border-top:1px solid rgba(16,185,129,0.4);
box-shadow:0 -8px 32px rgba(0,0,0,0.9),inset 0 1px 0 rgba(255,255,255,0.05);
}

.master-dropdown-wrapper{max-width:360px;margin:0 auto 1.5rem}

/* Instructions accordion */
.instructions-accordion{
margin-bottom:1.5rem;
}

.instructions-accordion-header{
padding:0.75rem 1rem;
font-size:0.95rem;
border-radius:16px;
background:rgba(0,0,0,0.6);
backdrop-filter:blur(40px) saturate(180%) brightness(1.1);
-webkit-backdrop-filter:blur(40px) saturate(180%) brightness(1.1);
border:1px solid rgba(16,185,129,0.3);
box-shadow:0 4px 20px rgba(0,0,0,0.6),0 0 20px rgba(16,185,129,0.6),inset 0 2px 0 rgba(255,255,255,0.05),inset 0 -2px 0 rgba(0,0,0,0.3);
color:var(‚Äìcolor-text-primary);
cursor:pointer;
transition:all 0.3s;
display:flex;
justify-content:space-between;
align-items:center;
user-select:none;
}

.instructions-accordion-header:hover{
background:rgba(0,0,0,0.8);
border-color:rgba(16,185,129,0.5);
box-shadow:0 6px 24px rgba(0,0,0,0.8),0 0 25px rgba(16,185,129,0.8),inset 0 2px 0 rgba(255,255,255,0.1),inset 0 -2px 0 rgba(0,0,0,0.3);
}

.instructions-accordion-content{
max-height:0;
overflow:hidden;
transition:max-height 0.3s ease;
margin-top:0.5rem;
}

.instructions-accordion.open .instructions-accordion-content{
max-height:5000px;
overflow-y:auto;
}

.instructions-card{
background:rgba(0,0,0,0.6);
backdrop-filter:blur(40px) saturate(180%) brightness(1.1);
-webkit-backdrop-filter:blur(40px) saturate(180%) brightness(1.1);
border-radius:16px;
border:1px solid rgba(118,75,162,0.3);
box-shadow:0 4px 20px rgba(0,0,0,0.6),inset 0 2px 0 rgba(255,255,255,0.05),inset 0 -2px 0 rgba(0,0,0,0.3);
padding:1.5rem;
max-height:70vh;
overflow-y:auto;
}

.instructions-card h3{
font-size:1.1rem;
font-weight:700;
background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);
-webkit-background-clip:text;
-webkit-text-fill-color:transparent;
background-clip:text;
margin:0 0 0.75rem 0;
}

.instructions-card h4{
font-size:0.95rem;
font-weight:700;
color:#10b981;
margin:1rem 0 0.5rem 0;
}

.instructions-card p{
font-size:0.9rem;
line-height:1.6;
color:var(‚Äìcolor-text-secondary);
margin:0 0 0.75rem 0;
}

.instructions-card ul{
font-size:0.9rem;
line-height:1.6;
color:var(‚Äìcolor-text-secondary);
margin:0 0 0.75rem 0;
padding-left:1.5rem;
}

.instructions-card li{
margin-bottom:0.5rem;
}

/* Base styles for selects and buttons */
select,button{
padding:0.75rem 1rem;
font-size:0.95rem;
border-radius:16px;
background:rgba(0,0,0,0.6);
backdrop-filter:blur(40px) saturate(180%) brightness(1.1);
-webkit-backdrop-filter:blur(40px) saturate(180%) brightness(1.1);
border:1px solid rgba(118,75,162,0.3);
box-shadow:0 4px 20px rgba(0,0,0,0.6),inset 0 2px 0 rgba(255,255,255,0.05),inset 0 -2px 0 rgba(0,0,0,0.3);
color:var(‚Äìcolor-text-primary);
cursor:pointer;
transition:all 0.3s;
font-family:inherit;
width:100%;
}
select:hover,button:hover{
background:rgba(0,0,0,0.8);
border-color:rgba(118,75,162,0.5);
}
select:focus,button:focus{
outline:none;
border-color:rgba(16,185,129,0.5);
box-shadow:0 0 0 3px rgba(16,185,129,0.2),0 0 20px rgba(16,185,129,0.4),inset 0 2px 0 rgba(255,255,255,0.1),inset 0 -2px 0 rgba(0,0,0,0.3);
}
select:active,button:active{transform:translateY(0)}

/* Master dropdown with purple glow */
#masterDropdown{
box-shadow:0 4px 20px rgba(0,0,0,0.6),0 0 20px rgba(118,75,162,0.6),inset 0 2px 0 rgba(255,255,255,0.05),inset 0 -2px 0 rgba(0,0,0,0.3);
}
#masterDropdown:hover{
box-shadow:0 6px 24px rgba(0,0,0,0.8),0 0 25px rgba(118,75,162,0.8),inset 0 2px 0 rgba(255,255,255,0.1),inset 0 -2px 0 rgba(0,0,0,0.3);
}
#masterDropdown:active{
box-shadow:0 0 0 3px rgba(16,185,129,0.2),0 0 30px rgba(118,75,162,1),inset 0 2px 0 rgba(255,255,255,0.05),inset 0 -2px 0 rgba(0,0,0,0.4);
}

.preview-group{
margin-bottom:1.5rem;
}

.preview-group-title{
font-size:0.75rem;
font-weight:700;
color:#10b981;
text-transform:uppercase;
letter-spacing:1.5px;
margin-bottom:0.75rem;
padding-left:0.5rem;
opacity:0.8;
}

.preview-group-content{
display:flex;
flex-direction:column;
gap:1rem;
}

/* Canvas quality and grid size with purple glow */
#canvasQuality,#gridSize{
box-shadow:0 4px 20px rgba(0,0,0,0.6),0 0 20px rgba(118,75,162,0.6),inset 0 2px 0 rgba(255,255,255,0.05),inset 0 -2px 0 rgba(0,0,0,0.3);
}
#canvasQuality:hover,#gridSize:hover{
box-shadow:0 6px 24px rgba(0,0,0,0.8),0 0 25px rgba(118,75,162,0.8),inset 0 2px 0 rgba(255,255,255,0.1),inset 0 -2px 0 rgba(0,0,0,0.3);
}
#canvasQuality:active,#gridSize:active{
box-shadow:0 0 0 3px rgba(16,185,129,0.2),0 0 30px rgba(118,75,162,1),inset 0 2px 0 rgba(255,255,255,0.05),inset 0 -2px 0 rgba(0,0,0,0.4);
}

/* Repeat type and background color with green glow */
#repeatType,#bgColor{
box-shadow:0 4px 20px rgba(0,0,0,0.6),0 0 20px rgba(16,185,129,0.6),inset 0 2px 0 rgba(255,255,255,0.05),inset 0 -2px 0 rgba(0,0,0,0.3);
}
#repeatType:hover,#bgColor:hover{
box-shadow:0 6px 24px rgba(0,0,0,0.8),0 0 25px rgba(16,185,129,0.8),inset 0 2px 0 rgba(255,255,255,0.1),inset 0 -2px 0 rgba(0,0,0,0.3);
}
#repeatType:active,#bgColor:active{
box-shadow:0 0 0 3px rgba(16,185,129,0.2),0 0 30px rgba(16,185,129,1),inset 0 2px 0 rgba(255,255,255,0.05),inset 0 -2px 0 rgba(0,0,0,0.4);
}

/* Country stores and view mode with purple glow */
#countryStores,#viewMode{
box-shadow:0 4px 20px rgba(0,0,0,0.6),0 0 20px rgba(118,75,162,0.6),inset 0 2px 0 rgba(255,255,255,0.05),inset 0 -2px 0 rgba(0,0,0,0.3);
}
#countryStores:hover,#viewMode:hover{
box-shadow:0 6px 24px rgba(0,0,0,0.8),0 0 25px rgba(118,75,162,0.8),inset 0 2px 0 rgba(255,255,255,0.1),inset 0 -2px 0 rgba(0,0,0,0.3);
}
#countryStores:active,#viewMode:active{
box-shadow:0 0 0 3px rgba(16,185,129,0.2),0 0 30px rgba(118,75,162,1),inset 0 2px 0 rgba(255,255,255,0.05),inset 0 -2px 0 rgba(0,0,0,0.4);
}

/* Slider dropdown specific glow colors - Purple for X offset and mockup zoom */
.slider-dropdown[data-slider=‚ÄúoffsetX‚Äù] .slider-dropdown-header,
.slider-dropdown[data-slider=‚ÄúmockupZoom‚Äù] .slider-dropdown-header{
box-shadow:0 4px 20px rgba(0,0,0,0.6),0 0 20px rgba(118,75,162,0.6),inset 0 2px 0 rgba(255,255,255,0.05),inset 0 -2px 0 rgba(0,0,0,0.3);
}

/* Green for Y offset and mockup rotate */
.slider-dropdown[data-slider=‚ÄúoffsetY‚Äù] .slider-dropdown-header,
.slider-dropdown[data-slider=‚ÄúmockupRotate‚Äù] .slider-dropdown-header{
box-shadow:0 4px 20px rgba(0,0,0,0.6),0 0 20px rgba(16,185,129,0.6),inset 0 2px 0 rgba(255,255,255,0.05),inset 0 -2px 0 rgba(0,0,0,0.3);
}

.slider-dropdown-header:hover{
background:rgba(0,0,0,0.8);
border-color:rgba(118,75,162,0.5);
}

.slider-dropdown[data-slider=‚ÄúoffsetX‚Äù] .slider-dropdown-header:hover,
.slider-dropdown[data-slider=‚ÄúmockupZoom‚Äù] .slider-dropdown-header:hover{
box-shadow:0 6px 24px rgba(0,0,0,0.8),0 0 25px rgba(118,75,162,0.8),inset 0 2px 0 rgba(255,255,255,0.1),inset 0 -2px 0 rgba(0,0,0,0.3);
}

.slider-dropdown[data-slider=‚ÄúoffsetY‚Äù] .slider-dropdown-header:hover,
.slider-dropdown[data-slider=‚ÄúmockupRotate‚Äù] .slider-dropdown-header:hover{
box-shadow:0 6px 24px rgba(0,0,0,0.8),0 0 25px rgba(16,185,129,0.8),inset 0 2px 0 rgba(255,255,255,0.1),inset 0 -2px 0 rgba(0,0,0,0.3);
}

.slider-dropdown[data-slider=‚ÄúoffsetX‚Äù] .slider-dropdown-header:active,
.slider-dropdown[data-slider=‚ÄúmockupZoom‚Äù] .slider-dropdown-header:active{
box-shadow:0 0 0 3px rgba(16,185,129,0.2),0 0 30px rgba(118,75,162,1),inset 0 2px 0 rgba(255,255,255,0.05),inset 0 -2px 0 rgba(0,0,0,0.4);
}

.slider-dropdown[data-slider=‚ÄúoffsetY‚Äù] .slider-dropdown-header:active,
.slider-dropdown[data-slider=‚ÄúmockupRotate‚Äù] .slider-dropdown-header:active{
box-shadow:0 0 0 3px rgba(16,185,129,0.2),0 0 30px rgba(16,185,129,1),inset 0 2px 0 rgba(255,255,255,0.05),inset 0 -2px 0 rgba(0,0,0,0.4);
}

/* Scale slider with purple glow */
.slider-dropdown[data-slider=‚Äúscale‚Äù] .slider-dropdown-header{
box-shadow:0 4px 20px rgba(0,0,0,0.6),0 0 20px rgba(118,75,162,0.6),inset 0 2px 0 rgba(255,255,255,0.05),inset 0 -2px 0 rgba(0,0,0,0.3);
}

.slider-dropdown[data-slider=‚Äúscale‚Äù] .slider-dropdown-header:hover{
box-shadow:0 6px 24px rgba(0,0,0,0.8),0 0 25px rgba(118,75,162,0.8),inset 0 2px 0 rgba(255,255,255,0.1),inset 0 -2px 0 rgba(0,0,0,0.3);
}

.slider-dropdown[data-slider=‚Äúscale‚Äù] .slider-dropdown-header:active{
box-shadow:0 0 0 3px rgba(16,185,129,0.2),0 0 30px rgba(118,75,162,1),inset 0 2px 0 rgba(255,255,255,0.05),inset 0 -2px 0 rgba(0,0,0,0.4);
}

.controls-section{
display:none;
transition:all 0.3s;
margin-top:1.5rem;
}
.controls-section.active{display:block}

.settings-dropdowns,.sliders-container{
display:flex;
flex-direction:column;
gap:1rem;
max-width:360px;
margin:0 auto;
}

.section-label{
font-size:0.85rem;
font-weight:700;
color:#667eea;
text-align:center;
margin-bottom:0.5rem;
text-transform:uppercase;
letter-spacing:1px;
}

.slider-dropdown{margin-bottom:0}

.slider-dropdown-header{
padding:0.75rem 1rem;
font-size:0.95rem;
border-radius:16px;
background:rgba(0,0,0,0.6);
backdrop-filter:blur(40px) saturate(180%) brightness(1.1);
-webkit-backdrop-filter:blur(40px) saturate(180%) brightness(1.1);
border:1px solid rgba(118,75,162,0.3);
box-shadow:0 4px 20px rgba(0,0,0,0.6),inset 0 2px 0 rgba(255,255,255,0.05),inset 0 -2px 0 rgba(0,0,0,0.3);
color:var(‚Äìcolor-text-primary);
cursor:pointer;
transition:all 0.3s;
display:flex;
justify-content:space-between;
align-items:center;
user-select:none;
}

.slider-dropdown-content{
max-height:0;
overflow:hidden;
transition:max-height 0.3s ease;
margin-top:0.5rem;
}
.slider-dropdown.open .slider-dropdown-content{max-height:200px}

.slider-group{
display:flex;
flex-direction:column;
gap:0.75rem;
padding:1.2rem 1.5rem;
background:rgba(0,0,0,0.6);
backdrop-filter:blur(40px) saturate(180%) brightness(1.1);
-webkit-backdrop-filter:blur(40px) saturate(180%) brightness(1.1);
border-radius:16px;
border:1px solid rgba(118,75,162,0.3);
box-shadow:0 4px 20px rgba(0,0,0,0.6),inset 0 2px 0 rgba(255,255,255,0.05),inset 0 -2px 0 rgba(0,0,0,0.3);
position:relative;
}

.slider-wrapper{position:relative}

/* Center line indicator for sliders */
.slider-wrapper.centered::before{
content:‚Äô‚Äô;
position:absolute;
left:50%;
top:50%;
transform:translate(-50%, -50%);
width:2px;
height:20px;
background:rgba(16,185,129,0.5);
pointer-events:none;
z-index:1;
}

.zoom-slider-wrapper{
margin-bottom:1rem;
}

.zoom-slider-header{
padding:0.75rem 1rem;
font-size:0.95rem;
border-radius:16px;
background:rgba(0,0,0,0.6);
backdrop-filter:blur(40px) saturate(180%) brightness(1.1);
-webkit-backdrop-filter:blur(40px) saturate(180%) brightness(1.1);
border:1px solid rgba(118,75,162,0.3);
box-shadow:0 4px 20px rgba(0,0,0,0.6),0 0 20px rgba(118,75,162,0.6),inset 0 2px 0 rgba(255,255,255,0.05),inset 0 -2px 0 rgba(0,0,0,0.3);
color:var(‚Äìcolor-text-primary);
cursor:pointer;
transition:all 0.3s;
display:flex;
justify-content:space-between;
align-items:center;
user-select:none;
}

.zoom-slider-header:hover{
background:rgba(0,0,0,0.8);
border-color:rgba(118,75,162,0.5);
box-shadow:0 6px 24px rgba(0,0,0,0.8),0 0 25px rgba(118,75,162,0.8),inset 0 2px 0 rgba(255,255,255,0.1),inset 0 -2px 0 rgba(0,0,0,0.3);
}

.zoom-slider-content{
max-height:0;
overflow:hidden;
transition:max-height 0.3s ease;
margin-top:0.5rem;
}
.zoom-slider-wrapper.open .zoom-slider-content{max-height:200px}

/* Range slider styles with gradient track */
input[type="range"]{
width:100%;
height:32px;
border-radius:20px;
background:linear-gradient(90deg,rgba(16,185,129,0.2) 0%,rgba(118,75,162,0.2) 100%);
border:1px solid rgba(118,75,162,0.3);
outline:none;
-webkit-appearance:none;
transition:all 0.3s;
box-shadow:inset 0 2px 4px rgba(0,0,0,0.8);
cursor:pointer;
}

/* Custom slider thumb with glassmorphism */
input[type="range"]::-webkit-slider-thumb{
-webkit-appearance:none;
width:65px;
height:30px;
border-radius:50px;
background:rgba(255,255,255,0.25);
cursor:pointer;
border:2px solid rgba(255,255,255,0.5);
box-shadow:
0 4px 16px rgba(0,0,0,0.6),
0 0 20px rgba(102,126,234,0.5),
inset 0 2px 8px rgba(255,255,255,0.6),
inset 0 -2px 8px rgba(0,0,0,0.2);
transition:all 0.3s ease;
backdrop-filter:blur(20px) saturate(180%);
-webkit-backdrop-filter:blur(20px) saturate(180%);
margin-top:0px;
}

input[type="range"]::-webkit-slider-runnable-track{
height:32px;
border-radius:20px;
background:linear-gradient(90deg,rgba(16,185,129,0.15) 0%,rgba(118,75,162,0.15) 100%);
border:1px solid rgba(118,75,162,0.3);
box-shadow:inset 0 2px 4px rgba(0,0,0,0.8);
}

input[type="range"]::-webkit-slider-thumb:hover{
transform:scale(1.05);
background:rgba(255,255,255,0.35);
border:2px solid rgba(255,255,255,0.7);
box-shadow:
0 6px 24px rgba(0,0,0,0.7),
0 0 30px rgba(102,126,234,0.7),
inset 0 2px 10px rgba(255,255,255,0.7),
inset 0 -2px 10px rgba(0,0,0,0.25);
}

input[type="range"]::-webkit-slider-thumb:active{
transform:scale(1.02);
background:rgba(255,255,255,0.3);
box-shadow:
0 2px 12px rgba(0,0,0,0.8),
0 0 35px rgba(118,75,162,0.9),
inset 0 2px 8px rgba(255,255,255,0.6),
inset 0 -2px 8px rgba(0,0,0,0.3);
}

/* Firefox slider thumb styles */
input[type="range"]::-moz-range-thumb{
width:65px;
height:30px;
border-radius:50px;
background:rgba(255,255,255,0.25);
cursor:pointer;
border:2px solid rgba(255,255,255,0.5);
box-shadow:
0 4px 16px rgba(0,0,0,0.6),
0 0 20px rgba(102,126,234,0.5),
inset 0 2px 8px rgba(255,255,255,0.6),
inset 0 -2px 8px rgba(0,0,0,0.2);
transition:all 0.3s ease;
}

input[type="range"]::-moz-range-track{
height:32px;
border-radius:20px;
background:linear-gradient(90deg,rgba(16,185,129,0.15) 0%,rgba(118,75,162,0.15) 100%);
border:1px solid rgba(118,75,162,0.3);
box-shadow:inset 0 2px 4px rgba(0,0,0,0.8);
}

input[type="range"]::-moz-range-thumb:hover{
transform:scale(1.05);
background:rgba(255,255,255,0.35);
border:2px solid rgba(255,255,255,0.7);
box-shadow:
0 6px 24px rgba(0,0,0,0.7),
0 0 30px rgba(102,126,234,0.7),
inset 0 2px 10px rgba(255,255,255,0.7),
inset 0 -2px 10px rgba(0,0,0,0.25);
}

input[type="range"]::-moz-range-thumb:active{
transform:scale(1.02);
background:rgba(255,255,255,0.3);
box-shadow:
0 2px 12px rgba(0,0,0,0.8),
0 0 35px rgba(118,75,162,0.9),
inset 0 2px 8px rgba(255,255,255,0.6),
inset 0 -2px 8px rgba(0,0,0,0.3);
}

/* ==================== WEATHER WIDGET - 2x4 GRID LAYOUT ==================== */
.weather-widget{
display:none;
align-items:center;
justify-content:space-between;
gap:0.3rem;
padding:1rem 0.9rem;
margin-bottom:1rem;
background:var(‚Äìcolor-glass);
backdrop-filter:blur(40px) saturate(180%) brightness(1.1);
-webkit-backdrop-filter:blur(40px) saturate(180%) brightness(1.1);
border-radius:20px;
border:1px solid rgba(16,185,129,0.4);
box-shadow:0 8px 32px rgba(0,0,0,0.8),inset 0 1px 0 rgba(255,255,255,0.05);
font-size:0.85rem;
max-width:900px;
margin-left:auto;
margin-right:auto;
flex-wrap:nowrap;
}

.weather-widget.visible{display:flex}
.weather-widget.loading{opacity:0.6}

.weather-col{
display:flex;
flex-direction:column;
align-items:center;
justify-content:center;
gap:0.1rem;
}

.weather-col-time{
min-width:65px;
}

.weather-col-condition{
min-width:60px;
max-width:70px;
}

.weather-col-location{
min-width:60px;
max-width:70px;
}

.weather-icon{font-size:1.0rem;line-height:1}
.weather-temp{
font-size:0.6rem;
font-weight:650;
color:#b794f6;
}
.weather-time{
font-size:0.6rem;
font-weight:600;
color:#10b981;
}
.weather-divider{
color:rgba(255,255,255,0.2);
font-weight:300;
font-size:0.6rem;
margin:0 -0.1rem;
}

.weather-condition-line1,
.weather-condition-line2{
font-size:0.60rem;
font-weight:600;
color:#10b981;
animation:condition-glow 4s ease-in-out infinite;
text-align:center;
line-height:1.05;
}

@keyframes condition-glow{
0%,100%{color:#10b981;text-shadow:0 0 10px rgba(16,185,129,0.6)}
50%{color:#b794f6;text-shadow:0 0 10px rgba(183,148,246,0.6)}
}

.weather-location-line1,
.weather-location-line2{
font-size:0.60rem;
font-weight:600;
color:#b794f6;
animation:location-glow 4s ease-in-out infinite;
text-align:center;
line-height:1.05;
}

@keyframes location-glow{
0%,100%{color:#b794f6;text-shadow:0 0 8px rgba(183,148,246,0.6)}
50%{color:#10b981;text-shadow:0 0 8px rgba(16,185,129,0.6)}
}

/* ==================== SOCIAL BUTTONS - SQUARE ICON BOXES ==================== */
.social-buttons{
display:flex;
align-items:center;
justify-content:center;
gap:0.75rem;
margin-bottom:1.5rem;
flex-wrap:nowrap;
}

.social-btn{
display:flex;
align-items:center;
justify-content:center;
width:72px;
height:72px;
border-radius:18px;
background:var(‚Äìcolor-glass);
backdrop-filter:blur(40px) saturate(180%) brightness(1.1);
-webkit-backdrop-filter:blur(40px) saturate(180%) brightness(1.1);
border:1px solid rgba(118,75,162,0.4);
box-shadow:0 8px 32px rgba(0,0,0,0.8),inset 0 1px 0 rgba(255,255,255,0.05);
cursor:pointer;
transition:all 0.3s;
text-decoration:none;
flex-shrink:0;
}

.social-btn:hover{
transform:translateY(-2px);
box-shadow:0 12px 40px rgba(0,0,0,0.9),inset 0 1px 0 rgba(255,255,255,0.1);
background:rgba(0,0,0,0.9);
}

.social-btn:active{
transform:translateY(0);
box-shadow:0 4px 16px rgba(0,0,0,0.8),inset 0 1px 0 rgba(255,255,255,0.05);
}

.social-btn img{
width:42px;
height:42px;
border-radius:6px;
object-fit:contain;
}
/* ==================== TOOLS SECTION ==================== */
.tools-section{display:none;margin-top:1.5rem}
.tools-section.active{display:block}

.tool-card{
background:rgba(0,0,0,0.6);
backdrop-filter:blur(40px) saturate(180%) brightness(1.1);
-webkit-backdrop-filter:blur(40px) saturate(180%) brightness(1.1);
border-radius:16px;
border:1px solid rgba(118,75,162,0.3);
box-shadow:0 4px 20px rgba(0,0,0,0.6),inset 0 2px 0 rgba(255,255,255,0.05),inset 0 -2px 0 rgba(0,0,0,0.3);
padding:1.2rem 1.5rem;
margin-bottom:1rem;
max-width:360px;
margin-left:auto;
margin-right:auto;
}

.tool-title{
font-size:1rem;
font-weight:700;
background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);
-webkit-background-clip:text;
-webkit-text-fill-color:transparent;
background-clip:text;
margin:0 0 0.75rem 0;
display:flex;
justify-content:space-between;
align-items:center;
}

/* Color palette toggle button */
.palette-toggle{
font-size:0.75rem;
padding:0.3rem 0.6rem;
border-radius:8px;
background:rgba(16,185,129,0.2);
color:#10b981;
cursor:pointer;
transition:all 0.3s;
border:1px solid rgba(16,185,129,0.3);
}
.palette-toggle:hover{background:rgba(16,185,129,0.3)}

/* Calculator recommendations toggle button */
.calc-recommendations-toggle{
font-size:0.75rem;
padding:0.3rem 0.6rem;
border-radius:8px;
background:rgba(118,75,162,0.2);
color:#764ba2;
cursor:pointer;
transition:all 0.3s;
border:1px solid rgba(118,75,162,0.3);
}
.calc-recommendations-toggle:hover{background:rgba(118,75,162,0.3)}

.calc-recommendations{
display:none;
margin-top:0.75rem;
padding-top:0.75rem;
border-top:1px solid rgba(255,255,255,0.1);
}
.calc-recommendations.active{display:block}

.calc-preset-group{margin-bottom:1rem}

.calc-preset-label{
font-size:0.8rem;
font-weight:700;
color:#10b981;
margin-bottom:0.5rem;
text-transform:uppercase;
letter-spacing:0.5px;
}

.calc-preset-buttons{
display:grid;
grid-template-columns:1fr 1fr;
gap:0.5rem;
}

/* Calculator preset buttons */
.calc-preset-btn{
padding:0.5rem 0.75rem;
border-radius:8px;
background:rgba(0,0,0,0.6);
backdrop-filter:blur(40px) saturate(180%) brightness(1.1);
-webkit-backdrop-filter:blur(40px) saturate(180%) brightness(1.1);
border:1px solid rgba(118,75,162,0.3);
box-shadow:0 2px 12px rgba(0,0,0,0.6),inset 0 1px 0 rgba(255,255,255,0.05);
color:var(‚Äìcolor-text-secondary);
font-size:0.75rem;
font-weight:600;
cursor:pointer;
transition:all 0.3s;
text-align:center;
}

.calc-preset-btn:hover{
background:rgba(0,0,0,0.8);
border-color:rgba(118,75,162,0.5);
transform:translateY(-1px);
box-shadow:0 3px 14px rgba(0,0,0,0.8),inset 0 1px 0 rgba(255,255,255,0.1);
}

.calc-preset-btn:active{
transform:translateY(0);
box-shadow:0 1px 8px rgba(0,0,0,0.6),inset 0 1px 0 rgba(255,255,255,0.05);
}

/* Color palette grid - 9 color swatches */
.color-palette{
display:grid;
grid-template-columns:repeat(9,1fr);
gap:0.5rem;
margin-top:0.75rem;
}

.color-palette.hex-mode{display:none}

.color-swatch{
width:100%;
aspect-ratio:1;
border-radius:8px;
border:2px solid rgba(118,75,162,0.3);
cursor:pointer;
transition:all 0.3s;
position:relative;
box-shadow:0 2px 8px rgba(0,0,0,0.6);
}

.color-swatch:hover{
transform:scale(1.1);
border-color:rgba(16,185,129,0.6);
box-shadow:0 4px 12px rgba(0,0,0,0.8);
}

.color-swatch:active{transform:scale(0.98)}

/* Hex tooltip that appears on hover */
.hex-tooltip{
position:absolute;
bottom:calc(100% + 8px);
left:50%;
transform:translateX(-50%);
background:rgba(0,0,0,0.95);
color:#fff;
padding:0.3rem 0.6rem;
border-radius:6px;
font-size:0.7rem;
font-weight:600;
white-space:nowrap;
pointer-events:none;
opacity:0;
transition:opacity 0.3s;
z-index:100;
border:1px solid rgba(16,185,129,0.3);
}

.color-swatch:hover .hex-tooltip{opacity:1}

/* Checkmark when color is copied */
.color-swatch.copied::after{
content:‚Äò‚úì‚Äô;
position:absolute;
top:50%;
left:50%;
transform:translate(-50%,-50%);
color:#fff;
font-size:20px;
font-weight:bold;
text-shadow:0 0 4px rgba(0,0,0,1);
}

/* Hex checker tool */
.hex-checker{display:none;margin-top:0.75rem}
.hex-checker.active{display:block}

.hex-input-row{display:flex;gap:0.5rem;margin-bottom:0.75rem}

.hex-input{
flex:1;
padding:0.75rem;
border-radius:12px;
background:rgba(0,0,0,0.6);
backdrop-filter:blur(40px) saturate(180%) brightness(1.1);
-webkit-backdrop-filter:blur(40px) saturate(180%) brightness(1.1);
border:1px solid rgba(118,75,162,0.3);
box-shadow:0 4px 20px rgba(0,0,0,0.6),inset 0 2px 0 rgba(255,255,255,0.05),inset 0 -2px 0 rgba(0,0,0,0.3);
color:var(‚Äìcolor-text-primary);
font-family:‚ÄòCourier New‚Äô,monospace;
font-size:0.95rem;
font-weight:600;
}

/* Live preview of hex color */
.hex-preview{
width:100%;
height:80px;
border-radius:12px;
border:2px solid rgba(118,75,162,0.3);
box-shadow:0 4px 12px rgba(0,0,0,0.6);
transition:all 0.3s;
}

/* Seamless test dropdown */
.seamless-test-dropdown{margin-bottom:1rem}

.seamless-test-dropdown select{
box-shadow:0 4px 20px rgba(0,0,0,0.6),0 0 20px rgba(16,185,129,0.6),inset 0 2px 0 rgba(255,255,255,0.05),inset 0 -2px 0 rgba(0,0,0,0.3);
}

.seamless-test-dropdown select:hover{
box-shadow:0 6px 24px rgba(0,0,0,0.8),0 0 25px rgba(16,185,129,0.8),inset 0 2px 0 rgba(255,255,255,0.1),inset 0 -2px 0 rgba(0,0,0,0.3);
}

.seamless-test-dropdown select:active{
box-shadow:0 0 0 3px rgba(16,185,129,0.2),0 0 30px rgba(16,185,129,1),inset 0 2px 0 rgba(255,255,255,0.05),inset 0 -2px 0 rgba(0,0,0,0.4);
}

/* Save pattern input and button */
.save-input-row{
display:flex;
gap:0.5rem;
margin-bottom:0.75rem;
}

.pattern-name-input{
flex:1;
padding:0.75rem;
border-radius:12px;
background:rgba(0,0,0,0.6);
backdrop-filter:blur(40px) saturate(180%) brightness(1.1);
-webkit-backdrop-filter:blur(40px) saturate(180%) brightness(1.1);
border:1px solid rgba(118,75,162,0.3);
box-shadow:0 4px 20px rgba(0,0,0,0.6),inset 0 2px 0 rgba(255,255,255,0.05),inset 0 -2px 0 rgba(0,0,0,0.3);
color:var(‚Äìcolor-text-primary);
font-size:0.95rem;
font-family:inherit;
}

.save-pattern-btn{
padding:0.75rem 1.5rem;
border-radius:12px;
background:rgba(0,0,0,0.6);
backdrop-filter:blur(40px) saturate(180%) brightness(1.1);
-webkit-backdrop-filter:blur(40px) saturate(180%) brightness(1.1);
border:1px solid rgba(16,185,129,0.3);
box-shadow:0 4px 20px rgba(0,0,0,0.6),0 0 20px rgba(16,185,129,0.6),inset 0 2px 0 rgba(255,255,255,0.05),inset 0 -2px 0 rgba(0,0,0,0.3);
color:var(‚Äìcolor-text-primary);
font-size:0.95rem;
font-weight:600;
cursor:pointer;
transition:all 0.3s;
white-space:nowrap;
}

.save-pattern-btn:hover{
background:rgba(0,0,0,0.8);
box-shadow:0 6px 24px rgba(0,0,0,0.8),0 0 25px rgba(16,185,129,0.8),inset 0 2px 0 rgba(255,255,255,0.1),inset 0 -2px 0 rgba(0,0,0,0.3);
transform:translateY(-2px);
}

.save-pattern-btn:disabled{
opacity:0.4;
cursor:not-allowed;
transform:none;
}

/* Saved patterns list */
.saved-patterns-list{
display:flex;
flex-direction:column;
gap:0.5rem;
max-height:300px;
overflow-y:auto;
}

.saved-pattern-item{
display:flex;
align-items:center;
gap:0.75rem;
padding:0.75rem;
border-radius:12px;
background:rgba(0,0,0,0.4);
border:1px solid rgba(118,75,162,0.2);
cursor:pointer;
transition:all 0.3s;
}

.saved-pattern-item:hover{
background:rgba(0,0,0,0.6);
border-color:rgba(16,185,129,0.3);
transform:translateX(4px);
}

.saved-pattern-thumb{
width:50px;
height:50px;
border-radius:8px;
object-fit:cover;
border:2px solid rgba(118,75,162,0.3);
}

.saved-pattern-info{
flex:1;
min-width:0;
}

.saved-pattern-name{
font-size:0.95rem;
font-weight:600;
color:var(‚Äìcolor-text-primary);
white-space:nowrap;
overflow:hidden;
text-overflow:ellipsis;
}

.saved-pattern-date{
font-size:0.75rem;
color:var(‚Äìcolor-text-muted);
}

.saved-pattern-delete{
padding:0.5rem;
width:44px;
height:44px;
flex-shrink:0;
border-radius:8px;
background:rgba(239,68,68,0.2);
border:1px solid rgba(239,68,68,0.3);
color:#ef4444;
cursor:pointer;
transition:all 0.3s;
font-size:0.9rem;
display:flex;
align-items:center;
justify-content:center;
}

.saved-pattern-delete:hover{
background:rgba(239,68,68,0.3);
transform:scale(1.1);
}

/* Dimension calculator slider */
.calc-single-slider{margin-top:0.75rem}

.calc-label-row{
display:flex;
justify-content:space-between;
align-items:center;
margin-bottom:0.5rem;
}

.calc-labels{display:flex;gap:0.5rem}

.calc-label{
font-size:1.2rem;
font-weight:700;
cursor:pointer;
padding:0.3rem 0.8rem;
border-radius:8px;
transition:all 0.3s;
user-select:none;
border:1px solid rgba(118,75,162,0.3);
background:rgba(118,75,162,0.2);
color:#764ba2;
}

.calc-label:hover{background:rgba(118,75,162,0.3)}

.calc-label.active{
background:rgba(16,185,129,0.2);
color:#10b981;
border:1px solid rgba(16,185,129,0.3);
}

.calc-label.active:hover{background:rgba(16,185,129,0.3)}

/* Unit switcher buttons (inches/cm) */
.calc-unit-buttons{display:flex;gap:0.5rem}

.calc-unit-btn{
font-size:0.8rem;
padding:0.3rem 0.6rem;
border-radius:6px;
cursor:pointer;
transition:all 0.3s;
border:1px solid rgba(118,75,162,0.3);
font-weight:600;
background:rgba(118,75,162,0.2);
color:#764ba2;
user-select:none;
}

.calc-unit-btn:hover{background:rgba(118,75,162,0.3)}

.calc-unit-btn.active{
background:rgba(16,185,129,0.2);
color:#10b981;
border:1px solid rgba(16,185,129,0.3);
}

.calc-unit-btn.active:hover{background:rgba(16,185,129,0.3)}

.calc-current-value{font-size:1.2rem;font-weight:700;color:#667eea}

/* Calculator result display */
.calc-result{
margin-top:1rem;
padding:0.75rem;
background:rgba(16,185,129,0.1);
border-radius:8px;
border:1px solid rgba(16,185,129,0.3);
text-align:center;
}

.calc-result-value{font-size:1.1rem;font-weight:700;color:#10b981}

/* ==================== STORES SECTION ==================== */
.stores-section{display:none;margin-top:1.5rem}
.stores-section.active{display:block}

.stores-intro{text-align:center;margin-bottom:1.5rem}

.stores-intro-text{
font-size:1.1rem;
font-weight:600;
color:var(‚Äìcolor-text-secondary);
margin-bottom:1rem;
}

.stores-dropdowns{
display:flex;
flex-direction:column;
gap:1rem;
max-width:360px;
margin:0 auto 2rem;
}

.mockup-sliders{
max-width:360px;
margin:0 auto;
padding-top:1.5rem;
border-top:1px solid rgba(255,255,255,0.1);
}

.mockup-section-label{
font-size:0.85rem;
font-weight:700;
color:#667eea;
text-align:center;
margin-bottom:1rem;
text-transform:uppercase;
letter-spacing:1px;
}

/* ==================== FOOTER ==================== */
#footer{
padding:2rem;
background:rgba(0,0,0,0.8);
backdrop-filter:blur(40px) saturate(180%);
-webkit-backdrop-filter:blur(40px) saturate(180%);
border-top:1px solid rgba(118,75,162,0.4);
box-shadow:0 -8px 32px rgba(0,0,0,0.9),inset 0 1px 0 rgba(255,255,255,0.05);
}

.footer-content{max-width:1200px;margin:0 auto;text-align:center}

.footer-credit{
font-weight:700;
background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);
-webkit-background-clip:text;
-webkit-text-fill-color:transparent;
background-clip:text;
font-size:1.1rem;
cursor:pointer;
transition:all 0.3s;
}
.footer-credit:hover{opacity:0.8;transform:scale(1.02)}

/* Pattern info bar with quality metrics */
.pattern-info{
display:none;
flex-wrap:wrap;
justify-content:center;
align-items:center;
gap:0.6rem;
padding:1rem 1.5rem;
margin-top:1rem;
}
.pattern-info.visible{display:flex}

.info-pill{
padding:0.5rem 1rem;
border-radius:20px;
font-size:0.85rem;
font-weight:600;
background:rgba(0,0,0,0.6);
backdrop-filter:blur(40px) saturate(180%) brightness(1.1);
-webkit-backdrop-filter:blur(40px) saturate(180%) brightness(1.1);
border:1px solid rgba(118,75,162,0.3);
box-shadow:0 2px 12px rgba(0,0,0,0.6),inset 0 1px 0 rgba(255,255,255,0.05);
animation:pill-glow 4s ease-in-out infinite;
white-space:nowrap;
}

/* Info pill glow animation */
@keyframes pill-glow{
0%,100%{
box-shadow:0 2px 12px rgba(0,0,0,0.6),0 0 10px rgba(118,75,162,0.4),inset 0 1px 0 rgba(255,255,255,0.05);
border-color:rgba(118,75,162,0.3);
}
50%{
box-shadow:0 2px 12px rgba(0,0,0,0.6),0 0 10px rgba(16,185,129,0.4),inset 0 1px 0 rgba(255,255,255,0.05);
border-color:rgba(16,185,129,0.3);
}
}

.info-pill .info-label{color:var(‚Äìcolor-text-muted);margin-right:0.3rem}

.info-pill .info-value{
background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);
-webkit-background-clip:text;
-webkit-text-fill-color:transparent;
background-clip:text;
font-weight:700;
}

.info-pill .info-value.success{
background:linear-gradient(135deg,#10b981 0%,#059669 100%);
-webkit-background-clip:text;
-webkit-text-fill-color:transparent;
background-clip:text;
}

.info-pill .info-value.warning{
background:linear-gradient(135deg,#f59e0b 0%,#d97706 100%);
-webkit-background-clip:text;
-webkit-text-fill-color:transparent;
background-clip:text;
}

/* ==================== EASTER EGG OVERLAY ==================== */
.easter-egg-overlay{
position:fixed;
top:0;
left:0;
right:0;
bottom:0;
background:rgba(0,0,0,0.98);
backdrop-filter:blur(30px);
-webkit-backdrop-filter:blur(30px);
display:none;
align-items:center;
justify-content:center;
z-index:20000;
opacity:0;
transition:opacity 0.5s;
overflow:hidden;
}
.easter-egg-overlay.visible{display:flex;opacity:1}

.easter-egg-logo{
width:150px;
height:150px;
opacity:0;
animation:spin-in 1s ease-out forwards,egg-glow 2s ease-in-out infinite 1s;
}

/* Easter egg logo animations */
@keyframes spin-in{
0%{transform:scale(0) rotate(0deg);opacity:0}
100%{transform:scale(1) rotate(720deg);opacity:1}
}

@keyframes spin-out{
0%{transform:scale(1) rotate(0deg);opacity:1}
100%{transform:scale(0) rotate(-720deg);opacity:0}
}

@keyframes egg-glow{
0%,100%{filter:drop-shadow(0 0 15px rgba(118,75,162,0.8))}
50%{filter:drop-shadow(0 0 20px rgba(16,185,129,0.8))}
}

.matrix-canvas{
position:absolute;
top:0;
left:0;
width:100%;
height:100%;
opacity:0;
transition:opacity 1s;
}
.matrix-canvas.visible{opacity:1}

/* ==================== INSTALL BANNER ==================== */
.install-banner{
position:fixed;
top:calc(env(safe-area-inset-top) + 1rem);
left:50%;
transform:translateX(-50%) translateY(-120%);
background:rgba(16,185,129,0.15);
backdrop-filter:blur(40px) saturate(180%) brightness(1.1);
-webkit-backdrop-filter:blur(40px) saturate(180%) brightness(1.1);
border:1px solid rgba(16,185,129,0.4);
border-radius:16px;
padding:1rem 1.5rem;
display:flex;
align-items:center;
gap:1rem;
z-index:9998;
transition:transform 0.3s ease;
box-shadow:0 8px 32px rgba(0,0,0,0.9),0 0 20px rgba(16,185,129,0.4);
max-width:90%;
}

.install-banner.visible{
transform:translateX(-50%) translateY(0);
}

.install-banner span{
color:var(‚Äìcolor-text-primary);
font-size:0.9rem;
font-weight:600;
}

.install-btn-small{
padding:0.5rem 1rem;
background:rgba(16,185,129,0.3);
border:1px solid rgba(16,185,129,0.5);
border-radius:12px;
color:#10b981;
font-weight:600;
font-size:0.85rem;
cursor:pointer;
transition:all 0.3s;
white-space:nowrap;
}

.install-btn-small:hover{
background:rgba(16,185,129,0.4);
transform:translateY(-2px);
}

.install-close{
padding:0.3rem 0.6rem;
background:rgba(0,0,0,0.6);
border:1px solid rgba(255,255,255,0.1);
border-radius:8px;
color:var(‚Äìcolor-text-muted);
font-size:0.9rem;
cursor:pointer;
transition:all 0.3s;
}

.install-close:hover{
background:rgba(0,0,0,0.8);
color:var(‚Äìcolor-text-primary);
}

/* ==================== RESPONSIVE STYLES ==================== */
@media(max-width:768px){
#header{
padding:1rem;
flex-direction:column;
align-items:stretch;
}
.logo-section{justify-content:center}
.header-buttons{gap:0.5rem;padding:0;max-width:100%}
.title{font-size:1.2rem}
#canvas-wrapper{padding:1rem}
#controls{padding:1.5rem 1rem}
.weather-widget{flex-wrap:wrap;gap:0.5rem;font-size:0.85rem}
.weather-temp{font-size:1.0rem}
.weather-icon{font-size:1.0rem}
.color-palette{grid-template-columns:repeat(9,1fr);gap:0.4rem}
.pattern-info{font-size:0.8rem;gap:0.4rem;padding:0.75rem 1rem}
.info-pill{font-size:0.75rem;padding:0.4rem 0.8rem}
.export-modal-content{padding:1.5rem}
.export-buttons{flex-direction:column}
.calc-preset-buttons{grid-template-columns:1fr}
.social-buttons{gap:0.5rem}
.social-btn{min-width:100px;padding:0.6rem 1.2rem;font-size:0.85rem}

.install-banner{
flex-direction:column;
gap:0.75rem;
padding:1rem;
}

.install-banner span{
font-size:0.85rem;
text-align:center;
}
}
</style>

<title>Seamless Pattern Checker</title>
</head>
<body>

<div id="container">
  <!-- ==================== HEADER SECTION ==================== -->
  <div id="header">
    <div class="logo-section">
      <img id="logo" src="https://raw.githubusercontent.com/1gby/seamless-checker/main/assets/icons/icon.png" alt="Rud3boy Logo">
      <h1 class="title">Seamless Pattern Checker</h1>
    </div>
    <div class="header-buttons">
      <div class="file-input-wrapper">
        <input type="file" id="fileInput" accept="image/*">
        <button class="upload-btn" id="uploadBtnHeader">üìÅ Upload</button>
      </div>
      <div class="file-input-wrapper">
        <select class="sample-btn" id="sampleSelect">
          <option value="">Sample</option>
          <option value="https://raw.githubusercontent.com/1gby/seamless-checker/main/assets/patterns/Seamless.png">Seamless</option>
          <option value="https://raw.githubusercontent.com/1gby/seamless-checker/main/assets/patterns/Mushrooms.png">Mushrooms</option>
          <option value="https://raw.githubusercontent.com/1gby/seamless-checker/main/assets/patterns/JoltCola.png">Jolt Cola</option>
          <option value="https://raw.githubusercontent.com/1gby/seamless-checker/main/assets/patterns/Beaver.png">Beaver</option>
          <option value="https://raw.githubusercontent.com/1gby/seamless-checker/main/assets/patterns/PinotNoir.png">Pinot Noir</option>
          <option value="https://raw.githubusercontent.com/1gby/seamless-checker/main/assets/patterns/Wu-Tang.png">Wu-Tang</option>
        </select>
      </div>
      <button class="export-btn-header" id="exportBtnHeader" disabled>üì§ Export</button>
    </div>
  </div>

  <!-- ==================== CANVAS AREA ==================== -->

  <div id="canvas-wrapper">
    <canvas id="canvas"></canvas>
    <div class="empty-state visible" id="emptyState">
      <div class="empty-state-icon">üé®</div>
      <div class="empty-state-text">Click to upload your pattern</div>
      <div class="empty-state-subtext">or drag & drop a square tile here</div>
    </div>
  </div>
  <!-- ==================== CONTROLS SECTION ==================== -->
  <div id="controls">

<!-- Master dropdown for section navigation -->
<div class="master-dropdown-wrapper">
  <select id="masterDropdown">
    <option value="">Settings</option>
    <option value="display">Preview Options</option>
    <option value="controls">Pattern Transform</option>
    <option value="tools">Tools</option>
    <option value="stores">Stores</option>
  </select>
</div>

<!-- Instructions accordion -->
<div class="instructions-accordion" id="instructionsAccordion">
  <div class="instructions-accordion-header">
    <span>üìö Instructions</span>
    <span>‚ñº</span>
  </div>
  <div class="instructions-accordion-content">
    <div class="instructions-card">
      <h3>üëã Welcome to P.I.M.P (Pattern Image Management Platform)</h3>
      <p>Your complete toolkit for creating, testing, and exporting seamless patterns for print-on-demand and digital products.</p>
      
      <h4>üì§ Getting Started</h4>
      <ul>
        <li><strong>Upload:</strong> Click the Upload button or drag & drop your square tile image</li>
        <li><strong>Sample:</strong> Try our pre-loaded patterns to explore features</li>
        <li><strong>Export:</strong> Save your work in multiple resolutions and formats (PNG or JPG)</li>
      </ul>
      
      <h4>‚öôÔ∏è Settings Menu</h4>
      <ul>
        <li><strong>Preview Options:</strong> Canvas quality, repeat patterns, backgrounds, grid overlays, and zoom control</li>
        <li><strong>Pattern Transform:</strong> Adjust offset X/Y, scale, and positioning with precision sliders</li>
        <li><strong>Tools:</strong> Color palette extractor, hex checker, dimension calculator, seamless edge test, and save patterns</li>
        <li><strong>Stores:</strong> Preview patterns on product mockups and access POD store links</li>
      </ul>
      
      <h4>üìê Dimension Calculator</h4>
      <p>Calculate perfect pixel dimensions for any size and DPI. Toggle between Size/DPI modes and switch units (inches/cm). Click "Recommendations" for instant presets:</p>
      <ul>
        <li><strong>Print Quality:</strong> 4"√ó4" @ 300 DPI, 6"√ó6" @ 300 DPI, 8"√ó8" @ 300 DPI, 12"√ó12" @ 300 DPI</li>
        <li><strong>Web/Digital:</strong> 512px, 1024px, 2048px, 4096px @ 72 DPI</li>
        <li><strong>Print-on-Demand:</strong> Redbubble (1600px), Society6 (2400px), Spoonflower (2000px), Zazzle (3200px)</li>
      </ul>
      
      <h4>üé® Color Tools</h4>
      <ul>
        <li><strong>Color Palette:</strong> Auto-extracts top 9 dominant colors from your pattern (click any swatch to copy hex code)</li>
        <li><strong>Hex Checker:</strong> Test any hex color with live preview - perfect for matching brand colors</li>
      </ul>
      
      <h4>üîç Pattern Testing & Display</h4>
      <ul>
        <li><strong>Repeat Types:</strong> Full Drop, Half Drop, Brick - see how your pattern tiles in different layouts</li>
        <li><strong>Grid Overlay:</strong> Toggle measurement grid (1", 2", 6", 12") to visualize scale</li>
        <li><strong>Seamless Test:</strong> Red edge overlay reveals alignment issues - found in Tools section</li>
        <li><strong>Zoom & Pan:</strong> Mouse wheel to zoom (1%-800%), click & drag to pan around canvas</li>
      </ul>
      
      <h4>üõçÔ∏è Product Mockups</h4>
      <ul>
        <li><strong>View Modes:</strong> Preview your pattern on phone cases, tote bags, mugs, bedding, and more</li>
        <li><strong>Mockup Controls:</strong> Adjust zoom (100%-150%) and rotation (0-360¬∞) for perfect product shots</li>
      </ul>
      
      <h4>üíæ Save Patterns</h4>
      <ul>
        <li><strong>Local Storage:</strong> Save your patterns with all settings to your browser</li>
        <li><strong>Quick Load:</strong> Click any saved pattern to restore it instantly</li>
        <li><strong>Management:</strong> Delete old patterns to keep your library organized</li>
      </ul>
      
      <h4>üí° Pro Tips</h4>
      <ul>
        <li>Use <strong>Ultra (2400px)</strong> or <strong>Max (3200px)</strong> canvas quality for final exports</li>
        <li>Always run the seamless test (Tools section) before uploading to print-on-demand stores</li>
        <li>Extract your color palette to create compelling product descriptions and tags</li>
        <li>Use the dimension calculator to ensure your pattern meets platform requirements</li>
        <li>Save your patterns frequently to avoid losing your work</li>
        <li>Pattern info bar shows quality score, contrast level, and unique color count</li>
      </ul>
      <h4>üì± Mobile Features</h4>
      <ul>
        <li><strong>Haptic Feedback:</strong> Feel subtle vibrations when tapping buttons, adjusting sliders, and completing actions (mobile only)</li>
        <li><strong>Install as App:</strong> Add to your home screen for a native app experience with offline access</li>
        <li><strong>Pinch to Zoom:</strong> Use two-finger pinch gestures to zoom on mobile devices</li>
      </ul>
      
      <h4>‚ö° Smart Loading</h4>
      <ul>
        <li><strong>Progress Tracking:</strong> Watch real-time progress bars when loading patterns and exporting files</li>
        <li><strong>Export Stages:</strong> See each step during export: creating canvas ‚Üí rendering ‚Üí generating file ‚Üí preparing download</li>
        <li><strong>Contextual Messages:</strong> Loading screens show file names, sizes, and current operations</li>
      </ul>
      
      <h4>üå§Ô∏è Live Weather Widget</h4>
      <ul>
        <li><strong>Real-Time Updates:</strong> Footer displays current temperature, weather conditions, time, and your location</li>
        <li><strong>Auto-Detection:</strong> Automatically detects your location and adjusts temperature units (¬∞F for US, ¬∞C elsewhere)</li>
      </ul>
      
      <h4>üìä Pattern Info Bar</h4>
      <ul>
        <li><strong>Quality Score:</strong> Excellent (3000px+), Good (2000px+), or Low (under 2000px)</li>
        <li><strong>Contrast Level:</strong> High (7+), Medium (3-7), or Low (under 3) - indicates visual pop</li>
        <li><strong>Canvas Size:</strong> Current rendering resolution (1200-3200px)</li>
        <li><strong>Unique Colors:</strong> Number of distinct colors detected in your pattern</li>
      </ul>

      <h4>üè™ Print-on-Demand Ready</h4>
      <p>Export at recommended sizes for all major POD platforms. The Stores section includes direct links to Redbubble, Society6, Spoonflower, Zazzle, Gelato, Contrado, and more.</p>
    </div>
  </div>
</div>

<!-- Display section - Preview options -->
<div class="controls-section" id="displaySection">
  
  <div class="preview-group">
    <div class="preview-group-title">Canvas & Quality</div>
    <div class="preview-group-content">
      <select id="canvasQuality">
        <option value="1200">Canvas Quality: Standard (1200px)</option>
        <option value="1600">Canvas Quality: High (1600px)</option>
        <option value="2400">Canvas Quality: Ultra (2400px)</option>
        <option value="3200">Canvas Quality: Max (3200px)</option>
      </select>
    </div>
  </div>

  <div class="preview-group">
    <div class="preview-group-title">Pattern Settings</div>
    <div class="preview-group-content">
      <select id="repeatType">
        <option value="full">Repeat Type: Full Drop</option>
        <option value="half-drop">Repeat Type: Half Drop</option>
        <option value="brick">Repeat Type: Brick</option>
      </select>
      <select id="bgColor">
        <option value="checker">Background: Transparent Grid</option>
        <option value="#000000">Background: Black</option>
        <option value="#ffffff">Background: White</option>
        <option value="#1a1a1a">Background: Gray</option>
      </select>
    </div>
  </div>

  <div class="preview-group">
    <div class="preview-group-title">View & Display</div>
    <div class="preview-group-content">
      <select id="gridSize">
        <option value="off">Grid Overlay: Off</option>
        <option value="1">Grid Overlay: 1 inch</option>
        <option value="2">Grid Overlay: 2 inches</option>
        <option value="6">Grid Overlay: 6 inches</option>
        <option value="12">Grid Overlay: 12 inches</option>
      </select>
    </div>
  </div>

  <div class="preview-group">
    <div class="preview-group-title">Zoom Control</div>
    <div class="preview-group-content">
      <div class="zoom-slider-wrapper" id="zoomSliderWrapper">
        <div class="zoom-slider-header">
          <span>Zoom</span>
          <span class="slider-value" id="zoomValue">100%</span>
        </div>
        <div class="zoom-slider-content">
          <div class="slider-group">
            <div class="slider-wrapper centered">
              <input type="range" id="zoomSlider" min="0" max="100" step="1" value="50">
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

</div>

<!-- Controls section - Pattern transform sliders -->
<div class="controls-section" id="controlsSection">
  <div class="sliders-container">
    
    <!-- Offset X slider -->
    <div class="slider-dropdown" data-slider="offsetX">
      <div class="slider-dropdown-header">
        <span>Offset X</span>
        <span class="slider-value" id="offsetXValue">0%</span>
      </div>
      <div class="slider-dropdown-content">
        <div class="slider-group">
          <div class="slider-wrapper">
            <input type="range" id="offsetX" min="0" max="100" value="0">
          </div>
        </div>
      </div>
    </div>

    <!-- Offset Y slider -->
    <div class="slider-dropdown" data-slider="offsetY">
      <div class="slider-dropdown-header">
        <span>Offset Y</span>
        <span class="slider-value" id="offsetYValue">0%</span>
      </div>
      <div class="slider-dropdown-content">
        <div class="slider-group">
          <div class="slider-wrapper">
            <input type="range" id="offsetY" min="0" max="100" value="0">
          </div>
        </div>
      </div>
    </div>

    <!-- Scale slider -->
    <div class="slider-dropdown" data-slider="scale">
      <div class="slider-dropdown-header">
        <span>Scale</span>
        <span class="slider-value" id="scaleValue">1.00√ó</span>
      </div>
      <div class="slider-dropdown-content">
        <div class="slider-group">
          <div class="slider-wrapper centered">
            <input type="range" id="patternScale" min="0" max="100" step="1" value="50">
          </div>
        </div>
      </div>
    </div>

  </div>
</div>

<!-- Tools section - Color palette, calculator, seamless test, save patterns -->
<div class="controls-section tools-section" id="toolsSection">

  <!-- Color palette tool -->
  <div class="tool-card" id="colorPaletteCard">
    <div class="tool-title">
      <span>üé® Color Palette</span>
      <span class="palette-toggle" id="paletteToggle">Hex Checker</span>
    </div>
    <div class="color-palette" id="colorPalette"></div>
    <div class="hex-checker" id="hexChecker">
      <div class="hex-input-row">
        <input type="text" class="hex-input" id="hexInput" placeholder="#FF0000" maxlength="7">
      </div>
      <div class="hex-preview" id="hexPreview"></div>
    </div>
  </div>

  <!-- Dimension calculator -->
  <div class="tool-card" id="dimensionCalcCard">
    <div class="tool-title">
      <span>üìê Dimension Calculator</span>
      <span class="calc-recommendations-toggle" id="calcRecommendationsToggle">Recommendations</span>
    </div>
    <div class="calc-single-slider">
      <div class="calc-label-row">
        <div class="calc-labels">
          <span class="calc-label active" id="labelSize" data-field="size">Size</span>
          <span class="calc-label" id="labelDPI" data-field="dpi">DPI</span>
        </div>
        <div class="calc-unit-buttons">
          <span class="calc-unit-btn active" id="btnInches" data-unit="inches">in</span>
          <span class="calc-unit-btn" id="btnCM" data-unit="cm">cm</span>
        </div>
      </div>
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:0.5rem">
        <span class="calc-current-value" id="currentValue">9 √ó 9"</span>
      </div>
      <input type="range" id="calcSlider" min="1" max="200" value="9">
    </div>
    
    <!-- Calculator presets -->
    <div class="calc-recommendations" id="calcRecommendations">
      <div class="calc-preset-group">
        <div class="calc-preset-label">Print Quality</div>
        <div class="calc-preset-buttons">
          <button class="calc-preset-btn" data-size="4" data-dpi="300" data-unit="in">4" √ó 4" @ 300 DPI</button>
          <button class="calc-preset-btn" data-size="6" data-dpi="300" data-unit="in">6" √ó 6" @ 300 DPI</button>
          <button class="calc-preset-btn" data-size="8" data-dpi="300" data-unit="in">8" √ó 8" @ 300 DPI</button>
          <button class="calc-preset-btn" data-size="12" data-dpi="300" data-unit="in">12" √ó 12" @ 300 DPI</button>
        </div>
      </div>
      
      <div class="calc-preset-group">
        <div class="calc-preset-label">Web/Digital</div>
        <div class="calc-preset-buttons">
          <button class="calc-preset-btn" data-px="512">512 √ó 512px</button>
          <button class="calc-preset-btn" data-px="1024">1024 √ó 1024px</button>
          <button class="calc-preset-btn" data-px="2048">2048 √ó 2048px</button>
          <button class="calc-preset-btn" data-px="4096">4096 √ó 4096px</button>
        </div>
      </div>
      
      <div class="calc-preset-group">
        <div class="calc-preset-label">Print-on-Demand</div>
        <div class="calc-preset-buttons">
          <button class="calc-preset-btn" data-size="10.67" data-dpi="150" data-unit="in">Redbubble (1600px)</button>
          <button class="calc-preset-btn" data-size="16" data-dpi="150" data-unit="in">Society6 (2400px)</button>
          <button class="calc-preset-btn" data-size="13.33" data-dpi="150" data-unit="in">Spoonflower (2000px)</button>
          <button class="calc-preset-btn" data-size="21.33" data-dpi="150" data-unit="in">Zazzle (3200px)</button>
        </div>
      </div>
    </div>
    
    <div class="calc-result">
      <div class="calc-result-value" id="calcResultValue">1350 √ó 1350px</div>
    </div>
  </div>

  <!-- Seamless test -->
  <div class="seamless-test-dropdown">
    <select id="seamlessTest">
      <option value="off">Seamless Test: Off</option>
      <option value="on">Seamless Test: On (Red Edges)</option>
    </select>
  </div>

  <!-- Save pattern -->
  <div class="tool-card" id="savePatternCard">
    <div class="tool-title">
      <span>üíæ Save Pattern</span>
    </div>
    <div class="save-input-row">
      <input type="text" class="pattern-name-input" id="patternNameInput" placeholder="Pattern name...">
      <button class="save-pattern-btn" id="savePatternBtn">Save</button>
    </div>
    <div class="saved-patterns-list" id="savedPatternsList"></div>
  </div>

</div>

<!-- Stores section - Product mockups and store links -->
<div class="controls-section stores-section" id="storesSection">
  <div class="stores-intro">
    <div class="stores-intro-text">Preview your pattern on products!</div>
  </div>
  
  <div class="stores-dropdowns">
    <select id="viewMode">
      <option value="tile">View Mode: Infinite Tile</option>
      <option value="tile-grid">View Mode: Infinite Tile + Grid</option>
      <option value="phone">Mockup: Phone Case</option>
      <option value="ipad">Mockup: iPad Case</option>
      <option value="tote">Mockup: Tote Bag</option>
      <option value="bandana">Mockup: Bandana</option>
      <option value="bedspread">Mockup: Bedspread</option>
      <option value="mug">Mockup: Mug</option>
      <option value="sweatshirt">Mockup: Sweatshirt</option>
      <option value="fabric">Mockup: Fabric Swatch</option>
      <option value="bottle">Mockup: Water Bottle</option>
    </select>
  </div>
  
  <!-- Mockup controls -->
  <div class="mockup-sliders">
    <div class="mockup-section-label">Mockup Controls</div>
    <div class="sliders-container">
      
      <div class="slider-dropdown" data-slider="mockupZoom">
        <div class="slider-dropdown-header">
          <span>Mockup Zoom</span>
          <span class="slider-value" id="mockupZoomValue">100%</span>
        </div>
        <div class="slider-dropdown-content">
          <div class="slider-group">
            <div class="slider-wrapper">
              <input type="range" id="mockupZoom" min="100" max="150" step="1" value="100">
            </div>
          </div>
        </div>
      </div>

      <div class="slider-dropdown" data-slider="mockupRotate">
        <div class="slider-dropdown-header">
          <span>Mockup Rotate</span>
          <span class="slider-value" id="mockupRotateValue">0¬∞</span>
        </div>
        <div class="slider-dropdown-content">
          <div class="slider-group">
            <div class="slider-wrapper">
              <input type="range" id="mockupRotate" min="0" max="360" step="1" value="0">
            </div>
          </div>
        </div>
      </div>

    </div>
  </div>
  
  <!-- Store links -->
  <div class="stores-intro" style="margin-top:2rem">
    <div class="stores-intro-text">Turn your patterns into real products!</div>
  </div>
  <div class="stores-dropdowns">
    <select id="countryStores">
      <option value="">Select Store</option>
      <option value="https://www.gelato.com/">Gelato üá™üá∫</option>
      <option value="https://www.contrado.co.uk/">Contrado üá™üá∫</option>
      <option value="https://www.saal-digital.com/">Saal Digital üá™üá∫</option>
      <option value="https://www.photobook-europe.com/">Photobook Europe üá™üá∫</option>
      <option value="https://www.whitewall.com/">WhiteWall üá™üá∫</option>
      <option value="https://www.canvaspeople.com/">CanvasPeople üá∫üá∏</option>
      <option value="https://www.canvaschamp.com/">CanvasChamp üá∫üá∏</option>
      <option value="https://www.mpix.com/">Mpix üá∫üá∏</option>
      <option value="https://www.canvaspop.com/">Canvaspop üá∫üá∏</option>
      <option value="https://canvasondemand.com/">Canvas On Demand üá∫üá∏</option>
      <option value="https://www.canvascanada.ca/">CanvasCanada.ca üá®üá¶</option>
      <option value="https://www.canvaschamp.ca/">CanvasChamp.ca üá®üá¶</option>
      <option value="https://www.bestcanvas.ca/">BestCanvas.ca üá®üá¶</option>
      <option value="https://www.canvaspop.com/">Canvaspop üá®üá¶</option>
      <option value="https://posterjack.ca/">Posterjack üá®üá¶</option>
    </select>
  </div>
</div>

<!-- Pattern info bar -->
<div class="pattern-info" id="patternInfo">
  <div class="info-pill">
    <span class="info-label">Pattern:</span>
    <span class="info-value" id="infoPattern">--</span>
  </div>
  <div class="info-pill">
    <span class="info-label">Quality:</span>
    <span class="info-value" id="infoQuality">--</span>
  </div>
  <div class="info-pill">
    <span class="info-label">Contrast:</span>
    <span class="info-value" id="infoContrast">--</span>
  </div>
  <div class="info-pill">
    <span class="info-label">Canvas:</span>
    <span class="info-value" id="infoCanvas">1200px</span>
  </div>
  <div class="info-pill">
    <span class="info-label">Colors:</span>
    <span class="info-value" id="infoColors">--</span>
  </div>
</div>

  </div>

  <!-- ==================== FOOTER SECTION ==================== -->

  <div id="footer">
    <div class="footer-content">

  <!-- Social buttons - Square icon boxes -->
  <div class="social-buttons">
    <a href="https://rud3boy.vercel.app/converter" target="_blank" class="social-btn conversion">
      <img src="https://raw.githubusercontent.com/1gby/seamless-checker/main/assets/icons/Rude.png" alt="Converter" onerror="this.style.display='none'">
    </a>
    
    <a href="https://ko-fi.com/rud3boy" target="_blank" class="social-btn kofi">
      <img src="https://storage.ko-fi.com/cdn/kofi_stroke_cup.svg" alt="Ko-fi" onerror="this.src='https://raw.githubusercontent.com/1gby/seamless-checker/main/assets/icons/rude.png'">
    </a>
    
    <a href="https://www.instagram.com/createdbyrudeboy" target="_blank" class="social-btn instagram">
      <img src="data:image/svg+xml,%3Csvg viewBox='0 0 24 24' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath fill='%23E4405F' d='M12 2.163c3.204 0 3.584.012 4.85.07 3.252.148 4.771 1.691 4.919 4.919.058 1.265.069 1.645.069 4.849 0 3.205-.012 3.584-.069 4.849-.149 3.225-1.664 4.771-4.919 4.919-1.266.058-1.644.07-4.85.07-3.204 0-3.584-.012-4.849-.07-3.26-.149-4.771-1.699-4.919-4.92-.058-1.265-.07-1.644-.07-4.849 0-3.204.013-3.583.07-4.849.149-3.227 1.664-4.771 4.919-4.919 1.266-.057 1.645-.069 4.849-.069zm0-2.163c-3.259 0-3.667.014-4.947.072-4.358.2-6.78 2.618-6.98 6.98-.059 1.281-.073 1.689-.073 4.948 0 3.259.014 3.668.072 4.948.2 4.358 2.618 6.78 6.98 6.98 1.281.058 1.689.072 4.948.072 3.259 0 3.668-.014 4.948-.072 4.354-.2 6.782-2.618 6.979-6.98.059-1.28.073-1.689.073-4.948 0-3.259-.014-3.667-.072-4.947-.196-4.354-2.617-6.78-6.979-6.98-1.281-.059-1.69-.073-4.949-.073zm0 5.838c-3.403 0-6.162 2.759-6.162 6.162s2.759 6.163 6.162 6.163 6.162-2.759 6.162-6.163c0-3.403-2.759-6.162-6.162-6.162zm0 10.162c-2.209 0-4-1.79-4-4 0-2.209 1.791-4 4-4s4 1.791 4 4c0 2.21-1.791 4-4 4zm6.406-11.845c-.796 0-1.441.645-1.441 1.44s.645 1.44 1.441 1.44c.795 0 1.439-.645 1.439-1.44s-.644-1.44-1.439-1.44z'/%3E%3C/svg%3E" alt="Instagram">
    </a>
  </div>
  
  <!-- Weather widget - 2x4 grid layout -->
  <div class="weather-widget" id="weatherWidget">

  <div class="weather-col">
    <span class="weather-icon" id="weatherIcon">üå§Ô∏è</span>
    <span class="weather-temp" id="weatherTemp">--¬∞</span>
  </div>
  <span class="weather-divider">|</span>
  <div class="weather-col weather-col-time">
    <span class="weather-time" id="weatherTime">--:--</span>
  </div>
  <span class="weather-divider">|</span>
  <div class="weather-col weather-col-condition">
  <span class="weather-condition-line1" id="weatherConditionLine1">It's Cloudy</span>
  <span class="weather-condition-line2" id="weatherConditionLine2">Bitch</span>
</div>
<span class="weather-divider">|</span>
<div class="weather-col weather-col-location">
  <span class="weather-location-line1" id="weatherLocationLine1">Edmonton,</span>
  <span class="weather-location-line2" id="weatherLocationLine2">Canada</span>
</div>
</div>

  <div class="footer-credit" id="easterEgg">Created by Rudeboy‚Ñ¢</div>
</div>

  </div>

</div>

<!-- ==================== EXPORT MODAL ==================== -->

<div class="export-modal" id="exportModal">
  <div class="export-modal-content">
    <div class="export-modal-title">üì§ Custom Export</div>
    <div class="export-options">
      <div class="export-option">
        <div class="export-option-label">Resolution</div>
        <select id="exportRes">
          <option value="current">Current Canvas (1200px)</option>
          <option value="1600">High (1600px)</option>
          <option value="2400">Ultra (2400px)</option>
          <option value="3200">Max (3200px)</option>
          <option value="4800">Print (4800px)</option>
          <option value="custom">Custom Size</option>
        </select>
      </div>
      <div class="export-option" id="customSizeOption" style="display:none">
        <div class="export-option-label">Custom Size (px)</div>
        <input type="number" id="customSize" min="100" max="10000" value="2400" placeholder="2400">
      </div>
      <div class="export-option">
        <div class="export-option-label">Format</div>
        <select id="exportFormat">
          <option value="png">PNG (Lossless)</option>
          <option value="jpg">JPG (Smaller)</option>
        </select>
      </div>
    </div>
    <div class="export-buttons">
      <button class="export-btn-confirm" id="exportConfirm">Export</button>
      <button class="export-btn-cancel" id="exportCancel">Cancel</button>
    </div>
  </div>
</div>

<!-- ==================== LOADING OVERLAY ==================== -->

<div class="loading-overlay" id="loadingOverlay">
  <img class="loading-logo" src="https://raw.githubusercontent.com/1gby/seamless-checker/main/assets/icons/icon.png" alt="Loading">
  <div class="loading-text" id="loadingText">Loading...</div>
  <div class="loading-subtext" id="loadingSubtext"></div>
  <div class="progress-bar-container" id="progressBarContainer">
    <div class="progress-bar-fill" id="progressBarFill"></div>
  </div>
</div>

<!-- ==================== EASTER EGG OVERLAY ==================== -->

<div class="easter-egg-overlay" id="easterEggOverlay">
  <canvas class="matrix-canvas" id="matrixCanvas"></canvas>
  <img class="easter-egg-logo" id="easterEggLogo" src="https://raw.githubusercontent.com/1gby/seamless-checker/main/assets/icons/icon.png" alt="Rudeboy">
</div>

<audio id="easterEggAudio" preload="none"></audio>

<script>
/* ==================== CORE JAVASCRIPT - HELPER FUNCTIONS ==================== */

// Helper function to draw rounded rectangles
function roundedRect(ctx, x, y, w, h, r) {
  ctx.beginPath();
  ctx.moveTo(x + r, y);
  ctx.lineTo(x + w - r, y);
  ctx.arcTo(x + w, y, x + w, y + r, r);
  ctx.lineTo(x + w, y + h - r);
  ctx.arcTo(x + w, y + h, x + w - r, y + h, r);
  ctx.lineTo(x + r, y + h);
  ctx.arcTo(x, y + h, x, y + h - r, r);
  ctx.lineTo(x, y + r);
  ctx.arcTo(x, y, x + r, y, r);
  ctx.closePath();
}

// Snap value to grid
function snap(val, step) {
  return Math.round(val / step) * step;
}

// Snap scale value to appropriate increments
function snapScale(val) {
  return val >= 0.25 ? snap(val, 0.25) : Math.max(0.05, snap(val, 0.01));
}

// Snap zoom value to appropriate increments
function snapZoom(val) {
  return val >= 25 ? snap(val, 25) : Math.max(1, Math.round(val));
}

/* ==================== DOM ELEMENTS REFERENCE ==================== */
const doc = document;
const getEl = doc.getElementById.bind(doc);

// Store all element references
const els = {
  canvas: getEl('canvas'),
  fileInput: getEl('fileInput'),
  uploadBtn: getEl('uploadBtnHeader'),
  sampleSelect: getEl('sampleSelect'),
  exportBtn: getEl('exportBtnHeader'),
  repeatType: getEl('repeatType'),
  viewMode: getEl('viewMode'),
  bgColor: getEl('bgColor'),
  canvasQuality: getEl('canvasQuality'),
  patternScale: getEl('patternScale'),
  offsetX: getEl('offsetX'),
  offsetY: getEl('offsetY'),
  zoomSlider: getEl('zoomSlider'),
  zoomSliderWrapper: getEl('zoomSliderWrapper'),
  mockupZoom: getEl('mockupZoom'),
  mockupRotate: getEl('mockupRotate'),
  scaleValue: getEl('scaleValue'),
  offsetXValue: getEl('offsetXValue'),
  offsetYValue: getEl('offsetYValue'),
  zoomValue: getEl('zoomValue'),
  mockupZoomValue: getEl('mockupZoomValue'),
  mockupRotateValue: getEl('mockupRotateValue'),
  emptyState: getEl('emptyState'),
  patternInfo: getEl('patternInfo'),
  infoPattern: getEl('infoPattern'),
  infoQuality: getEl('infoQuality'),
  infoContrast: getEl('infoContrast'),
  infoCanvas: getEl('infoCanvas'),
  infoColors: getEl('infoColors'),
  loadingOverlay: getEl('loadingOverlay'),
  easterEgg: getEl('easterEgg'),
  easterEggOverlay: getEl('easterEggOverlay'),
  easterEggLogo: getEl('easterEggLogo'),
  matrixCanvas: getEl('matrixCanvas'),
  audio: getEl('easterEggAudio'),
  masterDropdown: getEl('masterDropdown'),
  displaySection: getEl('displaySection'),
  controlsSection: getEl('controlsSection'),
  toolsSection: getEl('toolsSection'),
  storesSection: getEl('storesSection'),
  countryStores: getEl('countryStores'),
  weatherWidget: getEl('weatherWidget'),
  weatherIcon: getEl('weatherIcon'),
  weatherTemp: getEl('weatherTemp'),
  weatherTime: getEl('weatherTime'),
  weatherCondition: getEl('weatherCondition'),
  weatherLocation: getEl('weatherLocation'),
  colorPalette: getEl('colorPalette'),
  calcSlider: getEl('calcSlider'),
  labelSize: getEl('labelSize'),
  labelDPI: getEl('labelDPI'),
  currentValue: getEl('currentValue'),
  calcResultValue: getEl('calcResultValue'),
  btnInches: getEl('btnInches'),
  btnCM: getEl('btnCM'),
  seamlessTest: getEl('seamlessTest'),
  gridSize: getEl('gridSize'),
  exportModal: getEl('exportModal'),
  exportRes: getEl('exportRes'),
  exportFormat: getEl('exportFormat'),
  customSize: getEl('customSize'),
  customSizeOption: getEl('customSizeOption'),
  exportConfirm: getEl('exportConfirm'),
  exportCancel: getEl('exportCancel'),
  paletteToggle: getEl('paletteToggle'),
  hexChecker: getEl('hexChecker'),
  hexInput: getEl('hexInput'),
  hexPreview: getEl('hexPreview'),
  calcRecommendationsToggle: getEl('calcRecommendationsToggle'),
  calcRecommendations: getEl('calcRecommendations'),
  instructionsAccordion: getEl('instructionsAccordion'),
  patternNameInput: getEl('patternNameInput'),
  savedPatternsList: getEl('savedPatternsList')
};

const ctx = els.canvas.getContext('2d', { willReadFrequently: false });

/* ==================== STATE VARIABLES ==================== */
let tileImage = null;
let repeatType = 'full';
let backgroundColor = 'checker';
let viewMode = 'tile';
let scale = 1;
let offsetPercentX = 0;
let offsetPercentY = 0;
let panX = 0;
let panY = 0;
let zoom = 1;
let mockupZoom = 1;
let mockupRotate = 0;
let isDragging = false;
let dragStartX, dragStartY;
let maxCanvasSize = 1200;
let loadStartTime = 0;
let isReload = false;
let matrixActive = false;
let matrixInterval = null;
let seamlessTestMode = false;
let gridOverlaySize = 0;
let hexCheckerMode = false;
let useMetric = false;
let savedPatterns = JSON.parse(localStorage.getItem('rudeboy-patterns') || '[]');

// Mockup images storage
const mockupImages = {
  phone: null,
  bottle: null,
  tote: null,
  bandana: null,
  bedspread: null,
  ipad: null,
  mug: null,
  sweatshirt: null
};

/* ==================== CONSTANTS ==================== */
const MIN_ZOOM = 0.01;
const MAX_ZOOM = 8;
const MIN_LOAD_TIME = 1500;
const RELOAD_MIN_TIME = 1500;

/* ==================== MUSIC PLAYLIST FOR EASTER EGG ==================== */
const playlist = [
  {
    title: 'Capone',
    artist: 'Hey Pluto',
    url: 'https://raw.githubusercontent.com/1gby/seamless-checker/main/assets/secret%20stash/capone.mp3'
  },
  {
    title: 'Count',
    artist: 'Fonss',
    url: 'https://raw.githubusercontent.com/1gby/seamless-checker/main/assets/secret%20stash/count.mp3'
  },
  {
    title: 'Falling Softly',
    artist: 'Richard Smithson',
    url: 'https://raw.githubusercontent.com/1gby/seamless-checker/main/assets/secret%20stash/falling%20softly.mp3'
  },
  {
    title: 'Fluid',
    artist: 'Mountaineer',
    url: 'https://raw.githubusercontent.com/1gby/seamless-checker/main/assets/secret%20stash/fluid.mp3'
  },
  {
    title: 'I Wanna Take Your Body Higher',
    artist: 'SkyGaze',
    url: 'https://raw.githubusercontent.com/1gby/seamless-checker/main/assets/secret%20stash/i%20wanna%20take%20your%20body%20higher.mp3'
  },
  {
    title: 'Journey',
    artist: 'Tatami',
    url: 'https://raw.githubusercontent.com/1gby/seamless-checker/main/assets/secret%20stash/journey.mp3'
  },
  {
    title: 'Moments',
    artist: 'Tatami',
    url: 'https://raw.githubusercontent.com/1gby/seamless-checker/main/assets/secret%20stash/moments.mp3'
  },
  {
    title: 'Stardrive',
    artist: 'Simon Folwar',
    url: 'https://raw.githubusercontent.com/1gby/seamless-checker/main/assets/secret%20stash/stardrive.mp3'
  },
  {
    title: 'Sunset In Junipero',
    artist: 'Bach',
    url: 'https://raw.githubusercontent.com/1gby/seamless-checker/main/assets/secret%20stash/sunset%20in%20junipero.mp3'
  },
  {
    title: 'I Know',
    artist: 'Matrika',
    url: 'https://raw.githubusercontent.com/1gby/seamless-checker/main/assets/secret%20stash/IKnow.mp3'
  },
  {
    title: 'Other Worlds',
    artist: 'Carpetman',
    url: 'https://raw.githubusercontent.com/1gby/seamless-checker/main/assets/secret%20stash/OtherWorlds.mp3'
  },
  {
    title: 'JaffaDays',
    artist: 'ToneBreak',
    url: 'https://raw.githubusercontent.com/1gby/seamless-checker/main/assets/secret%20stash/JaffaDays.mp3'
  },
  {
    title: 'Baby Blue',
    artist: 'Action Bronson',
    url: 'https://raw.githubusercontent.com/1gby/seamless-checker/main/assets/secret%20stash/BabyBlue.mp3'
  }
];

let shuffledPlaylist = [...playlist];
let currentTrackIndex = 0;

// Shuffle playlist
function shuffleArray(array) {
  for (let i = array.length - 1; i > 0; i--) {
    const j = Math.floor(Math.random() * (i + 1));
    [array[i], array[j]] = [array[j], array[i]];
  }
}

shuffleArray(shuffledPlaylist);

/* ==================== UI INTERACTIONS ==================== */

// Instructions accordion toggle
els.instructionsAccordion.querySelector('.instructions-accordion-header').addEventListener('click', () => {
  const isOpen = els.instructionsAccordion.classList.contains('open');
  els.instructionsAccordion.classList.toggle('open', !isOpen);
  els.instructionsAccordion.querySelector('.instructions-accordion-header span:last-child').textContent = isOpen ? '‚ñº' : '‚ñ≤';
});

// Calculator recommendations toggle
els.calcRecommendationsToggle.addEventListener('click', () => {
  const isActive = els.calcRecommendations.classList.contains('active');
  els.calcRecommendations.classList.toggle('active', !isActive);
  els.calcRecommendationsToggle.textContent = isActive ? 'Recommendations' : 'Hide';
});

// Calculator preset buttons
doc.querySelectorAll('.calc-preset-btn').forEach(btn => {
  btn.addEventListener('click', () => {
    const size = btn.dataset.size;
    const dpi = btn.dataset.dpi;
    const unit = btn.dataset.unit;
    const px = btn.dataset.px;
    
    if (px) {
      // Pixel preset
      const pxVal = parseInt(px);
      const inches = pxVal / 72;
      calcValues.size = useMetric ? Math.round(inches * 2.54) : Math.round(inches);
      calcValues.dpi = 72;
      calcActiveField = 'size';
    } else {
      // Size + DPI preset
      if (unit === 'in' && useMetric) {
        calcValues.size = Math.round(parseFloat(size) * 2.54);
      } else if (unit === 'cm' && !useMetric) {
        calcValues.size = Math.round(parseFloat(size) / 2.54);
      } else {
        calcValues.size = Math.round(parseFloat(size));
      }
      calcValues.dpi = parseInt(dpi);
      calcActiveField = 'size';
    }
    
    updateCalcDisplay();
  });
});

/* ==================== TIME UPDATE ==================== */
function updateTime() {
  const now = new Date();
  const hours = now.getHours();
  const minutes = now.getMinutes();
  const ampm = hours >= 12 ? 'PM' : 'AM';
  const displayHours = hours % 12 || 12;
  const displayMinutes = minutes < 10 ? '0' + minutes : minutes;
  els.weatherTime.textContent = `${displayHours}:${displayMinutes} ${ampm}`;
}

setInterval(updateTime, 1000);
updateTime();

/* ==================== WEATHER FUNCTIONS ==================== */

// Get city name from coordinates using reverse geocoding
async function getCityName(lat, lon) {
  try {
    const response = await fetch(
      `https://nominatim.openstreetmap.org/reverse?lat=${lat}&lon=${lon}&format=json`
    );
    const data = await response.json();
    
    if (data && data.address) {
      const city = data.address.city || 
                   data.address.town || 
                   data.address.village || 
                   data.address.county || 
                   data.address.state;
      const country = data.address.country;
      
      if (city && country) {
        return `${city}, ${country}`;
      } else if (city) {
        return city;
      } else if (country) {
        return country;
      }
    }
    return 'Your Location';
  } catch (error) {
    console.error('Reverse geocoding error:', error);
    return 'Your Location';
  }
}

// Fetch weather data
async function getWeather() {
  els.weatherWidget.classList.add('visible');
  els.weatherWidget.classList.add('loading');
  
  if (!navigator.geolocation) {
    document.querySelector('.weather-condition-line1').textContent = 'Location';
    document.querySelector('.weather-condition-line2').textContent = 'unavailable';
    document.querySelector('.weather-location-line1').textContent = 'Geolocation not';
    document.querySelector('.weather-location-line2').textContent = 'supported';
    els.weatherWidget.classList.remove('loading');
    return;
  }
  
  navigator.geolocation.getCurrentPosition(async (position) => {
    const { latitude, longitude } = position.coords;
    
    try {
      const [weatherResponse, cityName] = await Promise.all([
        fetch(`https://api.open-meteo.com/v1/forecast?latitude=${latitude}&longitude=${longitude}&current_weather=true`),
        getCityName(latitude, longitude)
      ]);
      
      const data = await weatherResponse.json();
      
      if (data.current_weather) {
        displayWeatherOpenMeteo(data, latitude, longitude, cityName);
      }
    } catch (error) {
      console.error('Weather fetch error:', error);
      document.querySelector('.weather-condition-line1').textContent = 'Weather';
      document.querySelector('.weather-condition-line2').textContent = 'unavailable';
      els.weatherIcon.textContent = 'üåê';
      document.querySelector('.weather-location-line1').textContent = 'Service';
      document.querySelector('.weather-location-line2').textContent = 'unavailable';
      els.weatherWidget.classList.remove('loading');
    }
  }, (error) => {
    console.error('Geolocation error:', error);
    document.querySelector('.weather-condition-line1').textContent = 'Location';
    document.querySelector('.weather-condition-line2').textContent = 'denied';
    els.weatherIcon.textContent = 'üìç';
    document.querySelector('.weather-location-line1').textContent = 'Enable';
    document.querySelector('.weather-location-line2').textContent = 'location';
    els.weatherWidget.classList.remove('loading');
  });
}

// Display weather data in 2x4 grid layout
function displayWeatherOpenMeteo(data, lat, lon, cityName) {
  const tempC = Math.round(data.current_weather.temperature);
  const tempF = Math.round((tempC * 9/5) + 32);
  
  const isUS = (lat > 24 && lat < 50 && lon > -125 && lon < -66);
  const temp = isUS ? tempF : tempC;
  const unit = isUS ? '¬∞F' : '¬∞C';
  
  els.weatherTemp.textContent = `${temp}${unit}`;
  
  const condition = getRudeboyWeatherCondition(data.current_weather.weathercode);
  const conditionWords = condition.split(' ');
  const conditionMid = Math.ceil(conditionWords.length / 2);
  const conditionLine1 = conditionWords.slice(0, conditionMid).join(' ');
  const conditionLine2 = conditionWords.slice(conditionMid).join(' ');
  
  document.getElementById('weatherConditionLine1').textContent = conditionLine1;
  document.getElementById('weatherConditionLine2').textContent = conditionLine2;
  
  const locationParts = cityName.split(',');
  if (locationParts.length >= 2) {
    document.getElementById('weatherLocationLine1').textContent = locationParts[0].trim() + ',';
    document.getElementById('weatherLocationLine2').textContent = locationParts[1].trim();
  } else {
    document.getElementById('weatherLocationLine1').textContent = cityName;
    document.getElementById('weatherLocationLine2').textContent = '';
  }
  
  els.weatherIcon.textContent = getWeatherIconFromCode(data.current_weather.weathercode);
  els.weatherWidget.classList.remove('loading');
}

// Get weather icon from code
function getWeatherIconFromCode(code) {
  if (code === 0) return '‚òÄÔ∏è';
  if (code === 1 || code === 2) return 'üå§Ô∏è';
  if (code === 3) return '‚òÅÔ∏è';
  if (code === 45 || code === 48) return 'üå´Ô∏è';
  if (code >= 51 && code <= 67) return 'üåßÔ∏è';
  if (code >= 71 && code <= 77) return '‚ùÑÔ∏è';
  if (code >= 80 && code <= 82) return 'üå¶Ô∏è';
  if (code >= 85 && code <= 86) return '‚ùÑÔ∏è';
  if (code >= 95 && code <= 99) return '‚õàÔ∏è';
  return 'üå°Ô∏è';
}

// Get Rudeboy-style weather description
function getRudeboyWeatherCondition(code) {
  if (code === 0) return 'SunnySide Up';
  if (code === 1 || code === 2) return "It's Cloudy Bitch";
  if (code === 3) return "It's Cloudy Bitch";
  if (code === 45 || code === 48) return "Can't see shit";
  if (code >= 51 && code <= 67) return 'Wet T-Shirt Weather';
  if (code >= 71 && code <= 77) return 'Fucking Snow';
  if (code >= 80 && code <= 82) return "She's a squirter";
  if (code >= 85 && code <= 86) return 'Fucking Snow';
  if (code >= 95 && code <= 99) return 'Zeus is Pissed';
  return 'Unknown';
}

getWeather();

/* ==================== COLOR UTILITIES ==================== */

// Convert RGB to hex
function rgbToHex(r, g, b) {
  return '#' + [r, g, b].map(x => {
    const hex = x.toString(16);
    return hex.length === 1 ? '0' + hex : hex;
  }).join('');
}

// Convert hex to RGB
function hexToRgb(hex) {
  hex = hex.replace('#', '');
  if (hex.length === 3) {
    hex = hex.split('').map(c => c + c).join('');
  }
  const r = parseInt(hex.substring(0, 2), 16);
  const g = parseInt(hex.substring(2, 4), 16);
  const b = parseInt(hex.substring(4, 6), 16);
  return { r, g, b };
}

// Validate hex color
function isValidHex(hex) {
  return /^#?([0-9A-F]{3}|[0-9A-F]{6})$/i.test(hex);
}

// Palette toggle
els.paletteToggle.addEventListener('click', () => {
  hexCheckerMode = !hexCheckerMode;
  if (hexCheckerMode) {
    els.colorPalette.classList.add('hex-mode');
    els.hexChecker.classList.add('active');
    els.paletteToggle.textContent = 'Color Palette';
  } else {
    els.colorPalette.classList.remove('hex-mode');
    els.hexChecker.classList.remove('active');
    els.paletteToggle.textContent = 'Hex Checker';
  }
});

// Hex input handler
els.hexInput.addEventListener('input', (e) => {
  let hex = e.target.value.trim();
  
  if (hex.length > 0) {
    if (!hex.startsWith('#')) {
      hex = '#' + hex;
    }
    
    if (isValidHex(hex)) {
      const rgb = hexToRgb(hex);
      els.hexPreview.style.backgroundColor = `rgb(${rgb.r}, ${rgb.g}, ${rgb.b})`;
    }
  } else {
    els.hexPreview.style.backgroundColor = '#000000';
  }
});

els.hexInput.value = '';
els.hexInput.placeholder = 'FF0000 or #FF0000';
els.hexPreview.style.backgroundColor = '#FF0000';

/* ==================== PATTERN ANALYSIS ==================== */

// Analyze pattern and extract color palette
function analyzePattern() {
  if (!tileImage) return;
  
  const width = tileImage.width;
  const height = tileImage.height;
  
  els.infoPattern.textContent = `${width} √ó ${height}px`;
  
  // Quality assessment
  let qualityText = '';
  let qualityClass = '';
  
  if (width >= 3000 && height >= 3000) {
    qualityText = 'Excellent ‚úÖ';
    qualityClass = 'success';
  } else if (width >= 2000 && height >= 2000) {
    qualityText = 'Good ‚ö†Ô∏è';
    qualityClass = 'warning';
  } else {
    qualityText = 'Low ‚ùå';
    qualityClass = '';
  }
  
  els.infoQuality.textContent = qualityText;
  els.infoQuality.className = 'info-value ' + qualityClass;
  
  // Extract color palette
  const tempCanvas = doc.createElement('canvas');
  tempCanvas.width = Math.min(width, 500);
  tempCanvas.height = Math.min(height, 500);
  const tempCtx = tempCanvas.getContext('2d');
  tempCtx.drawImage(tileImage, 0, 0, tempCanvas.width, tempCanvas.height);
  
  const imageData = tempCtx.getImageData(0, 0, tempCanvas.width, tempCanvas.height);
  const data = imageData.data;
  const colorMap = new Map();
  
  // Count colors (grouped by 10s to reduce variation)
  for (let i = 0; i < data.length; i += 4) {
    const r = Math.round(data[i] / 10) * 10;
    const g = Math.round(data[i + 1] / 10) * 10;
    const b = Math.round(data[i + 2] / 10) * 10;
    const key = `${r},${g},${b}`;
    colorMap.set(key, (colorMap.get(key) || 0) + 1);
  }
  
  const uniqueColors = colorMap.size;
  els.infoColors.textContent = `${uniqueColors}`;
  
  // Get top 9 colors
  const sortedColors = Array.from(colorMap.entries())
    .sort((a, b) => b[1] - a[1])
    .slice(0, 9);
  
  // Display color palette
  els.colorPalette.innerHTML = '';
  sortedColors.forEach(([color]) => {
    const [r, g, b] = color.split(',').map(Number);
    const hex = rgbToHex(r, g, b);
    
    const swatch = doc.createElement('div');
    swatch.className = 'color-swatch';
    swatch.style.backgroundColor = `rgb(${r},${g},${b})`;
    
    const tooltip = doc.createElement('div');
    tooltip.className = 'hex-tooltip';
    tooltip.textContent = hex;
    swatch.appendChild(tooltip);
    
    swatch.addEventListener('click', () => {
      navigator.clipboard.writeText(hex).then(() => {
        triggerHaptic('light');
        swatch.classList.add('copied');
        setTimeout(() => swatch.classList.remove('copied'), 1000);
      });
    });
    
    els.colorPalette.appendChild(swatch);
  });
  
  // Calculate contrast ratio
  let minLum = 1;
  let maxLum = 0;
  
  sortedColors.forEach(([color]) => {
    const [r, g, b] = color.split(',').map(Number);
    const lum = (0.299 * r + 0.587 * g + 0.114 * b) / 255;
    minLum = Math.min(minLum, lum);
    maxLum = Math.max(maxLum, lum);
  });
  
  const contrastRatio = maxLum / (minLum + 0.05);
  
  if (contrastRatio > 7) {
    els.infoContrast.textContent = 'High';
    els.infoContrast.className = 'info-value success';
  } else if (contrastRatio > 3) {
    els.infoContrast.textContent = 'Medium';
    els.infoContrast.className = 'info-value warning';
  } else {
    els.infoContrast.textContent = 'Low';
    els.infoContrast.className = 'info-value';
  }
}

/* ==================== DIMENSION CALCULATOR ==================== */

let calcValues = {
  size: 9,
  dpi: 150
};

let calcActiveField = 'size';

// Update calculator display
function updateCalcDisplay() {
  [els.labelSize, els.labelDPI].forEach(label => {
    label.classList.remove('active');
  });
  
  const activeLabel = calcActiveField === 'size' ? els.labelSize : els.labelDPI;
  activeLabel.classList.add('active');
  
  const value = calcValues[calcActiveField];
  const unit = useMetric ? 'cm' : '"';
  
  if (calcActiveField === 'size') {
    els.currentValue.textContent = `${value} √ó ${value}${unit}`;
    
    if (useMetric) {
      els.calcSlider.min = '1';
      els.calcSlider.max = '500';
    } else {
      els.calcSlider.min = '1';
      els.calcSlider.max = '200';
    }
  } else {
    els.currentValue.textContent = value;
    els.calcSlider.min = '72';
    els.calcSlider.max = '600';
  }
  
  els.calcSlider.value = value;
  
  const sizeInInches = useMetric ? calcValues.size / 2.54 : calcValues.size;
  const px = Math.round(sizeInInches * calcValues.dpi);
  
  if (px === 1) {
    els.calcResultValue.textContent = `1 √ó 1px`;
  } else {
    els.calcResultValue.textContent = `${px} √ó ${px}px`;
  }
}

// Calculator field toggle
els.labelSize.addEventListener('click', () => {
  calcActiveField = 'size';
  updateCalcDisplay();
});

els.labelDPI.addEventListener('click', () => {
  calcActiveField = 'dpi';
  updateCalcDisplay();
});

// Unit toggle (inches/cm)
els.btnInches.addEventListener('click', () => {
  if (useMetric) {
    useMetric = false;
    els.btnInches.classList.add('active');
    els.btnCM.classList.remove('active');
    
    if (calcActiveField === 'size') {
      calcValues.size = Math.round(calcValues.size / 2.54);
      els.calcSlider.max = '200';
    }
    
    updateCalcDisplay();
  }
});

els.btnCM.addEventListener('click', () => {
  if (!useMetric) {
    useMetric = true;
    els.btnCM.classList.add('active');
    els.btnInches.classList.remove('active');
    
    if (calcActiveField === 'size') {
      calcValues.size = Math.round(calcValues.size * 2.54);
      els.calcSlider.max = '500';
    }
    
    updateCalcDisplay();
  }
});

// Calculator slider
els.calcSlider.addEventListener('input', (e) => {
  calcValues[calcActiveField] = parseInt(e.target.value);
  updateCalcDisplay();
});

updateCalcDisplay();

/* ==================== SAVE/LOAD PATTERNS ==================== */

// Save current pattern to localStorage
function savePattern() {
  if (!tileImage) {
    alert('Uh oh! It\'s not me, it\'s you. Try loading a pattern first!');
    return;
  }
  
  const patternName = els.patternNameInput.value.trim() || `Pattern ${Date.now()}`;
  
  const patternData = {
    id: Date.now(),
    name: patternName,
    timestamp: new Date().toISOString(),
    imageData: els.canvas.toDataURL('image/png'),
    settings: {
      scale,
      offsetPercentX,
      offsetPercentY,
      repeatType,
      backgroundColor,
      zoom,
      panX,
      panY
    }
  };
  
  savedPatterns.unshift(patternData);
  localStorage.setItem('rudeboy-patterns', JSON.stringify(savedPatterns));
  
  els.patternNameInput.value = '';
  renderSavedPatterns();
  
  triggerHaptic('success');
  alert(`‚úÖ "${patternName}" saved!`);
}

// Load saved pattern
function loadPattern(id) {
  const pattern = savedPatterns.find(p => p.id === id);
  if (!pattern) return;
  
  showLoading(false, {
    message: 'Loading saved pattern...',
    subtext: pattern.name,
    showProgress: true,
    progress: 30
  });
  
  let prog = 30;
  const loadInterval = setInterval(() => {
    prog += 15;
    if (prog <= 85) {
      updateLoadingProgress(prog, 'Loading saved pattern...');
    }
  }, 100);
  
  const img = new Image();
  img.onload = () => {
    clearInterval(loadInterval);
    updateLoadingProgress(100, 'Complete!');

    tileImage = img;
    
    scale = pattern.settings.scale;
    offsetPercentX = pattern.settings.offsetPercentX;
    offsetPercentY = pattern.settings.offsetPercentY;
    repeatType = pattern.settings.repeatType;
    backgroundColor = pattern.settings.backgroundColor;
    zoom = pattern.settings.zoom;
    panX = pattern.settings.panX;
    panY = pattern.settings.panY;
    
    els.patternScale.value = scale <= 1.0 ? Math.round(((scale - 0.05) / 0.95) * 50) : Math.round(50 + ((scale - 1.0) / 4.0) * 50);
    els.scaleValue.textContent = scale.toFixed(2) + '√ó';
    
    els.offsetX.value = Math.round(offsetPercentX * 100);
    els.offsetXValue.textContent = Math.round(offsetPercentX * 100) + '%';
    
    els.offsetY.value = Math.round(offsetPercentY * 100);
    els.offsetYValue.textContent = Math.round(offsetPercentY * 100) + '%';
    
    els.repeatType.value = repeatType;
    els.bgColor.value = backgroundColor;
    
    const zoomPercent = Math.round(zoom * 100);
    const zoomSliderVal = zoomPercent <= 100 ? Math.round(((zoomPercent - 1) / 99) * 50) : Math.round(50 + ((zoomPercent - 100) / 700) * 50);
    els.zoomSlider.value = zoomSliderVal;
    els.zoomValue.textContent = zoomPercent + '%';
    
    updateBackground();
    analyzePattern();
    els.patternInfo.classList.add('visible');
    draw();
    hideLoading();
  };
  
  img.src = pattern.imageData;
}

// Delete saved pattern
function deletePattern(id) {
  if (!confirm('Delete this pattern?')) return;
  
  savedPatterns = savedPatterns.filter(p => p.id !== id);
  localStorage.setItem('rudeboy-patterns', JSON.stringify(savedPatterns));
  triggerHaptic('medium');
  renderSavedPatterns();
}

// Render saved patterns list
function renderSavedPatterns() {
  els.savedPatternsList.innerHTML = '';
  
  if (savedPatterns.length === 0) {
    els.savedPatternsList.innerHTML = '<div style="text-align:center;color:#666;padding:1rem;font-size:0.9rem;">No saved patterns yet</div>';
    return;
  }
  
  savedPatterns.forEach(pattern => {
    const item = doc.createElement('div');
    item.className = 'saved-pattern-item';
    
    const thumb = doc.createElement('img');
    thumb.className = 'saved-pattern-thumb';
    thumb.src = pattern.imageData;
    
    const info = doc.createElement('div');
    info.className = 'saved-pattern-info';
    
    const name = doc.createElement('div');
    name.className = 'saved-pattern-name';
    name.textContent = pattern.name;
    
    const date = doc.createElement('div');
    date.className = 'saved-pattern-date';
    date.textContent = new Date(pattern.timestamp).toLocaleDateString();
    
    info.appendChild(name);
    info.appendChild(date);
    
    const deleteBtn = doc.createElement('button');
    deleteBtn.className = 'saved-pattern-delete';
    deleteBtn.textContent = 'üóëÔ∏è';
    deleteBtn.onclick = (e) => {
      e.stopPropagation();
      deletePattern(pattern.id);
    };
    
    item.appendChild(thumb);
    item.appendChild(info);
    item.appendChild(deleteBtn);
    
    item.onclick = () => loadPattern(pattern.id);
    
    els.savedPatternsList.appendChild(item);
  });
}

els.patternNameInput.addEventListener('keypress', (e) => {
  if (e.key === 'Enter') savePattern();
});

renderSavedPatterns();

getEl('savePatternBtn').addEventListener('click', savePattern);

// Seamless test toggle
els.seamlessTest.addEventListener('change', (e) => {
  seamlessTestMode = e.target.value === 'on';
  draw();
});

// Grid overlay toggle
els.gridSize.addEventListener('change', (e) => {
  gridOverlaySize = e.target.value === 'off' ? 0 : parseInt(e.target.value);
  draw();
});
/* ==================== EXPORT FUNCTIONALITY ==================== */

// Export modal handlers
els.exportRes.addEventListener('change', (e) => {
  if (e.target.value === 'custom') {
    els.customSizeOption.style.display = 'block';
  } else {
    els.customSizeOption.style.display = 'none';
  }
  
  if (e.target.value === 'current') {
    e.target.options[0].text = `Current Canvas (${maxCanvasSize}px)`;
  }
});

els.exportBtn.addEventListener('click', () => {
  if (!tileImage) return;
  triggerHaptic('light');
  els.exportRes.options[0].text = `Current Canvas (${maxCanvasSize}px)`;
  els.exportModal.classList.add('visible');
});

els.exportCancel.addEventListener('click', () => {
  els.exportModal.classList.remove('visible');
});

els.exportConfirm.addEventListener('click', async () => {
  if (!tileImage) return;
  
  let exportSize = maxCanvasSize;
  
  if (els.exportRes.value === 'custom') {
    exportSize = parseInt(els.customSize.value) || 2400;
  } else if (els.exportRes.value !== 'current') {
    exportSize = parseInt(els.exportRes.value);
  }
  
  els.exportModal.classList.remove('visible');
  showLoading(false, {
    message: `Exporting ${exportSize}√ó${exportSize}px...`,
    subtext: `${els.exportFormat.value.toUpperCase()} format`,
    showProgress: true,
    progress: 0
  });
  
  setTimeout(async () => {
    updateLoadingProgress(20, 'Creating canvas...');
    
    const exportCanvas = doc.createElement('canvas');
    exportCanvas.width = exportSize;
    exportCanvas.height = exportSize;
    const exportCtx = exportCanvas.getContext('2d');
    
    exportCtx.imageSmoothingEnabled = true;
    exportCtx.imageSmoothingQuality = 'high';
    
    updateLoadingProgress(40, 'Rendering pattern...');
    
    const tileSize = tileImage.width * scale;
    
    exportCtx.save();
    exportCtx.translate(panX * (exportSize / maxCanvasSize), panY * (exportSize / maxCanvasSize));
    exportCtx.scale(zoom, zoom);
    
    const tilesX = Math.ceil(exportSize / tileSize / zoom) + 6;
    const tilesY = Math.ceil(exportSize / tileSize / zoom) + 6;
    const startTileX = Math.floor(-(panX * (exportSize / maxCanvasSize)) / (tileSize * zoom)) - 3;
    const startTileY = Math.floor(-(panY * (exportSize / maxCanvasSize)) / (tileSize * zoom)) - 3;
    
    for (let i = startTileX; i < startTileX + tilesX; i++) {
      for (let j = startTileY; j < startTileY + tilesY; j++) {
        let drawX = i * tileSize + offsetPercentX * tileSize;
        let drawY = j * tileSize + offsetPercentY * tileSize;
        
        if (repeatType === 'half-drop') {
          drawY += (Math.abs(i) % 2 === 1) ? tileSize / 2 : 0;
        } else if (repeatType === 'brick') {
          drawX += (Math.abs(j) % 2 === 1) ? tileSize / 2 : 0;
        }
        
        exportCtx.drawImage(tileImage, drawX, drawY, tileSize, tileSize);
      }
    }
    
    exportCtx.restore();
    
    updateLoadingProgress(70, 'Generating image file...');
    
    const format = els.exportFormat.value === 'jpg' ? 'image/jpeg' : 'image/png';
    const quality = els.exportFormat.value === 'jpg' ? 0.95 : undefined;
    
    exportCanvas.toBlob(async (blob) => {
      updateLoadingProgress(90, 'Preparing download...');
      
      const ext = els.exportFormat.value === 'jpg' ? '.jpg' : '.png';
      const file = new File([blob], `rudeboy-pattern-${exportSize}px${ext}`, { type: format });
      
      try {
        if (navigator.share && navigator.canShare && navigator.canShare({ files: [file] })) {
          await navigator.share({
            files: [file],
            title: 'Rudeboy Pattern',
            text: `Check out my ${exportSize}px pattern!`
          });
        } else {
          const link = doc.createElement('a');
          link.download = `rudeboy-pattern-${exportSize}px${ext}`;
          link.href = URL.createObjectURL(blob);
          link.click();
          URL.revokeObjectURL(link.href);
        }
      } catch (e) {
        if (e.name !== 'AbortError') {
          const link = doc.createElement('a');
          link.download = `rudeboy-pattern-${exportSize}px${ext}`;
          link.href = URL.createObjectURL(blob);
          link.click();
          URL.revokeObjectURL(link.href);
        }
      }
      
      updateLoadingProgress(100, 'Complete!');
      triggerHaptic('success');
      hideLoading();
    }, format, quality);
  }, 100);
});

/* ==================== NAVIGATION & UI ==================== */

// Master dropdown navigation
els.masterDropdown.addEventListener('change', (e) => {
  [els.displaySection, els.controlsSection, els.toolsSection, els.storesSection]
    .forEach(section => section.classList.remove('active'));
  
  const sections = {
    display: els.displaySection,
    controls: els.controlsSection,
    tools: els.toolsSection,
    stores: els.storesSection
  };
  
  if (sections[e.target.value]) {
    sections[e.target.value].classList.add('active');
    els.instructionsAccordion.style.display = 'none';
  } else {
    els.instructionsAccordion.style.display = 'block';
  }
});

// Store links
els.countryStores.addEventListener('change', (e) => {
  if (e.target.value) {
    window.open(e.target.value, '_blank');
    e.target.value = '';
  }
});

// Slider dropdowns
doc.querySelectorAll('.slider-dropdown-header').forEach(header => {
  header.addEventListener('click', () => {
    const parent = header.parentElement;
    const wasOpen = parent.classList.contains('open');
    doc.querySelectorAll('.slider-dropdown').forEach(sd => sd.classList.remove('open'));
    if (!wasOpen) parent.classList.add('open');
  });
});

els.zoomSliderWrapper.querySelector('.zoom-slider-header').addEventListener('click', () => {
  const wasOpen = els.zoomSliderWrapper.classList.contains('open');
  els.zoomSliderWrapper.classList.toggle('open', !wasOpen);
});

/* ==================== LOADING FUNCTIONS ==================== */

function showLoading(reload = false, options = {}) {
  const {
    message = 'Loading...',
    subtext = '',
    showProgress = false,
    progress = 0
  } = options;
  
  isReload = reload;
  loadStartTime = Date.now();
  
  const loadingText = getEl('loadingText');
  if (loadingText) {
    loadingText.textContent = message;
  }
  
  const loadingSubtext = getEl('loadingSubtext');
  if (loadingSubtext) {
    loadingSubtext.textContent = subtext;
  }
  
  const progressContainer = getEl('progressBarContainer');
  const progressFill = getEl('progressBarFill');
  
  if (showProgress && progressContainer && progressFill) {
    progressContainer.classList.add('visible');
    progressFill.style.width = `${progress}%`;
  } else if (progressContainer) {
    progressContainer.classList.remove('visible');
  }
  
  els.loadingOverlay.classList.add('visible');
}

function hideLoading() {
  const elapsed = Date.now() - loadStartTime;
  const remaining = Math.max(0, (isReload ? RELOAD_MIN_TIME : MIN_LOAD_TIME) - elapsed);
  setTimeout(() => {
    els.loadingOverlay.classList.remove('visible');
    const progressContainer = getEl('progressBarContainer');
    const progressFill = getEl('progressBarFill');
    if (progressContainer) progressContainer.classList.remove('visible');
    if (progressFill) progressFill.style.width = '0%';
  }, remaining);
}

function updateLoadingProgress(percent, message) {
  const progressFill = getEl('progressBarFill');
  const loadingText = getEl('loadingText');
  
  if (progressFill) progressFill.style.width = `${percent}%`;
  if (loadingText && message) loadingText.textContent = message;
}

/* ==================== HAPTIC FEEDBACK ==================== */

function triggerHaptic(pattern = 'light') {
  if (!navigator.vibrate) return;
  
  const patterns = {
    light: 10,
    medium: 20,
    heavy: 30,
    success: [20, 10, 20],
    error: [50, 20, 50, 20, 50],
    selection: 5
  };
  
  navigator.vibrate(patterns[pattern] || 10);
}

/* ==================== PWA FUNCTIONALITY ==================== */

function checkStandaloneMode() {
  const isStandalone = window.matchMedia('(display-mode: standalone)').matches || 
                       window.navigator.standalone || 
                       document.referrer.includes('android-app://');
  
  if (isStandalone) {
    document.body.classList.add('standalone-mode');
    console.log('üé® Running in standalone mode');
  }
  
  return isStandalone;
}

let deferredPrompt;
const isInstalledPWA = checkStandaloneMode();

window.addEventListener('beforeinstallprompt', (e) => {
  e.preventDefault();
  deferredPrompt = e;
  
  if (!isInstalledPWA) {
    showInstallPrompt();
  }
});

function showInstallPrompt() {
  const installBanner = doc.createElement('div');
  installBanner.className = 'install-banner';
  installBanner.innerHTML = `
    <span>üì± Install as app for better experience</span>
    <button class="install-btn-small" id="installBtn">Install</button>
    <button class="install-close" id="installClose">‚úï</button>
  `;
  
  doc.body.appendChild(installBanner);
  setTimeout(() => installBanner.classList.add('visible'), 1000);
  
  getEl('installBtn')?.addEventListener('click', async () => {
    if (deferredPrompt) {
      deferredPrompt.prompt();
      const { outcome } = await deferredPrompt.userChoice;
      console.log(`Install prompt: ${outcome}`);
      deferredPrompt = null;
      installBanner.remove();
    }
  });
  
  getEl('installClose')?.addEventListener('click', () => {
    installBanner.classList.remove('visible');
    setTimeout(() => installBanner.remove(), 300);
  });
  
  setTimeout(() => {
    if (installBanner.parentElement) {
      installBanner.classList.remove('visible');
      setTimeout(() => installBanner.remove(), 300);
    }
  }, 10000);
}

/* ==================== EASTER EGG - MUSIC PLAYER ==================== */

function playRandomTrack() {
  if (currentTrackIndex >= shuffledPlaylist.length) {
    shuffleArray(shuffledPlaylist);
    currentTrackIndex = 0;
  }
  
  const track = shuffledPlaylist[currentTrackIndex];
  currentTrackIndex++;
  
  els.audio.src = track.url;
  els.audio.volume = 0;
  els.audio.loop = false;
  
  els.audio.play().then(() => {
    if ('mediaSession' in navigator) {
      navigator.mediaSession.metadata = new MediaMetadata({
        title: track.title,
        artist: track.artist,
        album: 'Secret Stash',
        artwork: [
          { src: 'https://raw.githubusercontent.com/1gby/seamless-checker/main/assets/icons/nova.png', sizes: '512x512', type: 'image/png' }
        ]
      });
    }
    
    let vol = 0;
    const fadeIn = setInterval(() => {
      if (vol < 0.5) {
        vol += 0.05;
        els.audio.volume = Math.min(vol, 0.5);
      } else {
        clearInterval(fadeIn);
      }
    }, 100);
  }).catch(err => {
    console.log('Audio play failed:', err);
    if (matrixActive) {
      playRandomTrack();
    }
  });
}

els.audio.addEventListener('ended', () => {
  if (matrixActive) {
    playRandomTrack();
  }
});

if ('mediaSession' in navigator) {
  navigator.mediaSession.setActionHandler('play', () => {
    if (matrixActive && els.audio.paused) {
      els.audio.play();
    }
  });
  
  navigator.mediaSession.setActionHandler('pause', () => {
    if (matrixActive) {
      els.audio.pause();
    }
  });
  
  navigator.mediaSession.setActionHandler('nexttrack', () => {
    if (matrixActive) {
      playRandomTrack();
    }
  });
  
  navigator.mediaSession.setActionHandler('previoustrack', () => {
    if (matrixActive) {
      currentTrackIndex = Math.max(0, currentTrackIndex - 2);
      playRandomTrack();
    }
  });
}

function stopMusic() {
  if (!els.audio.paused) {
    let vol = els.audio.volume;
    const fadeOut = setInterval(() => {
      if (vol > 0) {
        vol -= 0.05;
        els.audio.volume = Math.max(vol, 0);
      } else {
        clearInterval(fadeOut);
        els.audio.pause();
        els.audio.currentTime = 0;
      }
    }, 50);
  }
}

/* ==================== EASTER EGG - MATRIX ANIMATION ==================== */

function startMatrix(){
const canvas=els.matrixCanvas,ctx=canvas.getContext('2d');
canvas.width=window.innerWidth;canvas.height=window.innerHeight;
const msg='CREATED BY RUDEBOY';
const fontSize=Math.ceil(canvas.width/msg.length);
const drops=[];
const dropSpeeds=[];

for(let i=0;i<msg.length;i++){
drops[i]=Math.random()*-100;
dropSpeeds[i]=0.5+Math.random()*1.5;
}

let messageMode=false;
let activeWords=[];
const words=['CREATED','BY','RUDEBOY'];
const wordStartPositions=[0,8,11];
const wordLengths=[7,2,7];
let messageTimer=0;
const MESSAGE_INTERVAL=30000;
let currentSpeed=50;

function draw(){
if(messageMode){
ctx.fillStyle='rgba(0,0,0,0.05)';
}else{
ctx.fillStyle='rgba(0,0,0,0.25)';
}
ctx.fillRect(0,0,canvas.width,canvas.height);
ctx.font=fontSize+'px monospace';

if(!messageMode){
messageTimer+=currentSpeed;
if(messageTimer>=MESSAGE_INTERVAL){
messageMode=true;
activeWords=[0];
messageTimer=0;
for(let i=0;i<msg.length;i++){
drops[i]=-100;
dropSpeeds[i]=1;
}
for(let i=0;i<7;i++){
drops[i]=0;
}
clearInterval(matrixInterval);
currentSpeed=75;
matrixInterval=setInterval(draw,currentSpeed);
}
}

for(let i=0;i<msg.length;i++){
let char;
if(messageMode){
let shouldShow=false;
for(let w of activeWords){
const wordStart=wordStartPositions[w];
const wordEnd=wordStart+wordLengths[w];
if(i>=wordStart&&i<wordEnd){
char=msg[i];
shouldShow=true;
break;
}
}
if(!shouldShow){
char=' ';
}
}else{
char=msg[i];
}

ctx.fillStyle=i%2===0?'#10b981':'#764ba2';
ctx.fillText(char,i*fontSize,drops[i]*fontSize);

if(drops[i]*fontSize>canvas.height&&Math.random()>0.975){
drops[i]=Math.random()*-100;
if(!messageMode){
dropSpeeds[i]=0.5+Math.random()*1.5;
}
}

drops[i]+=dropSpeeds[i];
}

if(messageMode){
if(activeWords.length===1&&activeWords[0]===0){
const createdMaxDrop=Math.max(...drops.slice(0,7));
if(createdMaxDrop*fontSize>canvas.height/2){
activeWords.push(1);
for(let j=8;j<10;j++){
drops[j]=0;
}
}
}
if(activeWords.length===2&&activeWords[1]===1){
const byMaxDrop=Math.max(...drops.slice(8,10));
if(byMaxDrop*fontSize>canvas.height/2){
activeWords.push(2);
for(let j=11;j<18;j++){
drops[j]=0;
}
}
}
if(activeWords.length===3){
const rudeboyMaxDrop=Math.max(...drops.slice(11,18));
if(rudeboyMaxDrop*fontSize>canvas.height+fontSize*5){
messageMode=false;
activeWords=[];
for(let j=0;j<msg.length;j++){
drops[j]=Math.random()*-100;
dropSpeeds[j]=0.5+Math.random()*1.5;
}
clearInterval(matrixInterval);
currentSpeed=50;
matrixInterval=setInterval(draw,currentSpeed);
}
}
}
}
matrixInterval=setInterval(draw,currentSpeed);
}

function stopMatrix() {
  if (matrixInterval) {
    clearInterval(matrixInterval);
    matrixInterval = null;
  }
}

els.easterEgg.addEventListener('click', () => {
  if (matrixActive) return;
  
  matrixActive = true;
  els.easterEggOverlay.classList.add('visible');
  playRandomTrack();
  
  setTimeout(() => {
    els.easterEggLogo.style.animation = 'none';
    els.easterEggLogo.style.opacity = '0';
    els.easterEggLogo.style.transition = 'opacity 0.5s';
    
    setTimeout(() => {
      els.easterEggLogo.style.display = 'none';
      els.matrixCanvas.classList.add('visible');
      startMatrix();
    }, 500);
  }, 1000);
});

els.easterEggOverlay.addEventListener('click', () => {
  if (!matrixActive) return;
  
  matrixActive = false;
  els.matrixCanvas.classList.remove('visible');
  stopMatrix();
  stopMusic();
  
  setTimeout(() => {
    els.easterEggLogo.style.display = 'block';
    els.easterEggLogo.style.animation = 'spin-out 1s ease-in forwards';
    
    setTimeout(() => {
      els.easterEggOverlay.classList.remove('visible');
      els.easterEggLogo.style.animation = 'spin-in 1s ease-out forwards, egg-glow 2s ease-in-out infinite 1s';
    }, 1000);
  }, 500);
});

/* ==================== LOAD MOCKUP IMAGES ==================== */

(function loadMockupImages() {
  const images = [
    { key: 'phone', url: 'https://raw.githubusercontent.com/1gby/seamless-checker/main/assets/Mockups/iphone.png' },
    { key: 'bottle', url: 'https://raw.githubusercontent.com/1gby/seamless-checker/main/assets/Mockups/bottle.png' },
    { key: 'tote', url: 'https://raw.githubusercontent.com/1gby/seamless-checker/main/assets/Mockups/tote.png' },
    { key: 'bandana', url: 'https://raw.githubusercontent.com/1gby/seamless-checker/main/assets/Mockups/bandana.png' },
    { key: 'bedspread', url: 'https://raw.githubusercontent.com/1gby/seamless-checker/main/assets/Mockups/bedspread.png' },
    { key: 'ipad', url: 'https://raw.githubusercontent.com/1gby/seamless-checker/main/assets/Mockups/ipad.png' },
    { key: 'mug', url: 'https://raw.githubusercontent.com/1gby/seamless-checker/main/assets/Mockups/mug.png' },
    { key: 'sweatshirt', url: 'https://raw.githubusercontent.com/1gby/seamless-checker/main/assets/Mockups/sweatshirt.png' }
  ];
  
  images.forEach(({ key, url }) => {
    const img = new Image();
    img.crossOrigin = 'anonymous';
    img.src = url;
    img.onload = () => {
      mockupImages[key] = img;
      if (tileImage) draw();
    };
    img.onerror = () => console.error(`${key} failed to load`);
  });
})();

/* ==================== CANVAS MANAGEMENT ==================== */

function updateCanvasInfo() {
  els.infoCanvas.textContent = `${maxCanvasSize}px`;
}

function resizeCanvas() {
  const size = Math.min(els.canvas.parentElement.clientWidth - 64, maxCanvasSize);
  els.canvas.width = size;
  els.canvas.height = size;
  updateBackground();
  updateCanvasInfo();
  draw();
}

window.addEventListener('resize', resizeCanvas);
resizeCanvas();

// Logo reload functionality
getEl('logo').addEventListener('click', () => {
  showLoading(true, {
    message: 'Reloading...',
    subtext: 'Refreshing Pattern Checker',
    showProgress: true,
    progress: 50
  });
  
  let prog = 50;
  const reloadInterval = setInterval(() => {
    prog += 10;
    updateLoadingProgress(Math.min(prog, 90), 'Reloading...');
  }, 280);
  
  setTimeout(() => {
    clearInterval(reloadInterval);
    updateLoadingProgress(100, 'Complete!');
    setTimeout(() => location.reload(), 200);
  }, 2500);
});

/* ==================== CANVAS INTERACTIONS ==================== */

els.canvas.addEventListener('click', () => {
  if (!tileImage && !isDragging) els.fileInput.click();
});

els.uploadBtn.addEventListener('click', () => {
  triggerHaptic('light');
  els.fileInput.click();
});

// Sample pattern loader
els.sampleSelect.addEventListener('change', (e) => {
  const url = e.target.value;
  if (!url) return;
  
  showLoading(false, {
    message: 'Loading sample pattern...',
    subtext: url.split('/').pop(),
    showProgress: true,
    progress: 20
  });
  
  let prog = 20;
  const sampleInterval = setInterval(() => {
    prog += 15;
    if (prog <= 80) {
      updateLoadingProgress(prog, 'Loading sample pattern...');
    }
  }, 150);
  
  const img = new Image();
  img.crossOrigin = 'anonymous';
  
  img.onload = () => {
    clearInterval(sampleInterval);
    updateLoadingProgress(100, 'Complete!');
    tileImage = img;
    scale = Math.max(0.05, Math.min(5, 300 / tileImage.width));
    
    let sliderVal;
    if (scale <= 1.0) {
      sliderVal = Math.round(((scale - 0.05) / 0.95) * 50);
    } else {
      sliderVal = Math.round(50 + ((scale - 1.0) / 4.0) * 50);
    }
    
    els.patternScale.value = sliderVal;
    els.scaleValue.textContent = scale.toFixed(2) + '√ó';
    updateBackground();
    analyzePattern();
    els.patternInfo.classList.add('visible');
    draw();
    hideLoading();
    e.target.value = '';
  };
  
  img.onerror = () => {
    clearInterval(sampleInterval);
    hideLoading();
    alert('Failed to load sample!');
    e.target.value = '';
  };
  
  img.src = url;
});

// Canvas quality change
els.canvasQuality.addEventListener('change', (e) => {
  maxCanvasSize = parseInt(e.target.value);
  resizeCanvas();
});

/* ==================== BACKGROUND MANAGEMENT ==================== */

function updateBackground() {
  if (tileImage) {
    els.canvas.style.background = backgroundColor === 'checker' ?
      'repeating-conic-gradient(#ccc 0% 25%,#999 0% 50%,#ccc 50% 75%,#999 75% 100%)' : backgroundColor;
    els.canvas.style.backgroundSize = backgroundColor === 'checker' ? '40px 40px' : '100% 100%';
  } else {
    els.canvas.style.background = 'repeating-conic-gradient(#2a2a2a 0% 25%,#1a1a1a 0% 50%,#2a2a2a 50% 75%,#1a1a1a 75% 100%)';
    els.canvas.style.backgroundSize = '40px 40px';
  }
}

/* ==================== DRAWING FUNCTIONS ==================== */

// Draw pattern to context
function drawPatternToContext(ctx, startX, startY, width, height, tileSize) {
  const tilesX = Math.ceil(width / tileSize) + 4;
  const tilesY = Math.ceil(height / tileSize) + 4;
  
  for (let i = -2; i < tilesX; i++) {
    for (let j = -2; j < tilesY; j++) {
      let drawX = startX + i * tileSize + offsetPercentX * tileSize;
      let drawY = startY + j * tileSize + offsetPercentY * tileSize;
      
      if (repeatType === 'half-drop') {
        drawY += (Math.abs(i) % 2 === 1) ? tileSize / 2 : 0;
      } else if (repeatType === 'brick') {
        drawX += (Math.abs(j) % 2 === 1) ? tileSize / 2 : 0;
      }
      
      ctx.drawImage(tileImage, drawX, drawY, tileSize, tileSize);
    }
  }
}

// Draw seamless test overlay
function drawSeamlessTest(tileSize) {
  ctx.save();
  ctx.strokeStyle = 'rgba(255,0,0,0.8)';
  ctx.lineWidth = 3 / zoom;
  
  const tilesX = Math.ceil(els.canvas.width / tileSize / zoom) + 6;
  const tilesY = Math.ceil(els.canvas.height / tileSize / zoom) + 6;
  const startTileX = Math.floor(-panX / (tileSize * zoom)) - 3;
  const startTileY = Math.floor(-panY / (tileSize * zoom)) - 3;
  
  for (let i = startTileX; i < startTileX + tilesX; i++) {
    for (let j = startTileY; j < startTileY + tilesY; j++) {
      let drawX = i * tileSize + offsetPercentX * tileSize;
      let drawY = j * tileSize + offsetPercentY * tileSize;
      
      if (repeatType === 'half-drop') {
        drawY += (Math.abs(i) % 2 === 1) ? tileSize / 2 : 0;
      } else if (repeatType === 'brick') {
        drawX += (Math.abs(j) % 2 === 1) ? tileSize / 2 : 0;
      }
      
      ctx.strokeRect(drawX, drawY, tileSize, tileSize);
    }
  }
  
  ctx.restore();
}

// Draw grid overlay
function drawGridOverlay(tileSize) {
  if (gridOverlaySize === 0) return;
  
  ctx.save();
  ctx.strokeStyle = 'rgba(255,255,255,0.5)';
  ctx.lineWidth = 2 / zoom;
  ctx.setLineDash([5 / zoom, 5 / zoom]);
  
  const dpi = 150;
  const gridPixelSize = gridOverlaySize * dpi;
  
  const startX = Math.floor(-panX / zoom / gridPixelSize) * gridPixelSize;
  const startY = Math.floor(-panY / zoom / gridPixelSize) * gridPixelSize;
  const endX = startX + Math.ceil(els.canvas.width / zoom / gridPixelSize + 2) * gridPixelSize;
  const endY = startY + Math.ceil(els.canvas.height / zoom / gridPixelSize + 2) * gridPixelSize;
  
  for (let x = startX; x <= endX; x += gridPixelSize) {
    ctx.beginPath();
    ctx.moveTo(x, startY);
    ctx.lineTo(x, endY);
    ctx.stroke();
  }
  
  for (let y = startY; y <= endY; y += gridPixelSize) {
    ctx.beginPath();
    ctx.moveTo(startX, y);
    ctx.lineTo(endX, y);
    ctx.stroke();
  }
  
  ctx.restore();
}

// Draw mockup with pattern
function drawMockup(mockupImg) {
  if (!mockupImg || !mockupImg.complete || !mockupImg.naturalWidth) return;
  
  const displaySize = Math.min(els.canvas.width, els.canvas.height) * 0.72 * mockupZoom;
  
  const mockupCanvas = doc.createElement('canvas');
  mockupCanvas.width = displaySize;
  mockupCanvas.height = displaySize;
  const mockupCtx = mockupCanvas.getContext('2d');
  mockupCtx.drawImage(mockupImg, 0, 0, displaySize, displaySize);
  
  const mockupData = mockupCtx.getImageData(0, 0, displaySize, displaySize);
  const pixels = mockupData.data;
  
  const patternCanvas = doc.createElement('canvas');
  patternCanvas.width = displaySize;
  patternCanvas.height = displaySize;
  const patternCtx = patternCanvas.getContext('2d');
  
  patternCtx.save();
  patternCtx.translate(displaySize / 2, displaySize / 2);
  patternCtx.scale(zoom, zoom);
  patternCtx.translate(-displaySize / 2, -displaySize / 2);
  drawPatternToContext(patternCtx, 0, 0, displaySize, displaySize, tileImage.width * scale);
  patternCtx.restore();
  
  const patternData = patternCtx.getImageData(0, 0, displaySize, displaySize);
  const patternPixels = patternData.data;
  
  // Replace green pixels with pattern
  for (let i = 0; i < pixels.length; i += 4) {
    const r = pixels[i];
    const g = pixels[i + 1];
    const b = pixels[i + 2];
    const a = pixels[i + 3];
    
    const isGreen = (g > 200) && (g > r + 50) && (g > b + 50) && (r < 50) && (b < 50) && (a > 0);
    
    if (isGreen) {
      pixels[i] = patternPixels[i];
      pixels[i + 1] = patternPixels[i + 1];
      pixels[i + 2] = patternPixels[i + 2];
      pixels[i + 3] = patternPixels[i + 3];
    }
  }
  
  mockupCtx.putImageData(mockupData, 0, 0);
  
  ctx.rotate(mockupRotate * Math.PI / 180);
  ctx.drawImage(mockupCanvas, -displaySize / 2, -displaySize / 2);
}

// Main draw function
function draw() {
  ctx.clearRect(0, 0, els.canvas.width, els.canvas.height);
  
  if (!tileImage) {
    els.emptyState.classList.add('visible');
    els.canvas.classList.remove('has-image');
    els.exportBtn.disabled = true;
    return;
  }
  
  els.emptyState.classList.remove('visible');
  els.canvas.classList.add('has-image');
  els.exportBtn.disabled = false;
  
  const tileSize = tileImage.width * scale;
  const showGrid = viewMode === 'tile-grid';
  
  ctx.imageSmoothingEnabled = true;
  ctx.imageSmoothingQuality = 'high';
  ctx.save();
  
  if (viewMode === 'tile' || viewMode === 'tile-grid') {
    ctx.translate(panX, panY);
    ctx.scale(zoom, zoom);
    
    const tilesX = Math.ceil(els.canvas.width / tileSize / zoom) + 6;
    const tilesY = Math.ceil(els.canvas.height / tileSize / zoom) + 6;
    const startTileX = Math.floor(-panX / (tileSize * zoom)) - 3;
    const startTileY = Math.floor(-panY / (tileSize * zoom)) - 3;
    
    for (let i = startTileX; i < startTileX + tilesX; i++) {
      for (let j = startTileY; j < startTileY + tilesY; j++) {
        let drawX = i * tileSize + offsetPercentX * tileSize;
        let drawY = j * tileSize + offsetPercentY * tileSize;
        
        if (repeatType === 'half-drop') {
          drawY += (Math.abs(i) % 2 === 1) ? tileSize / 2 : 0;
        } else if (repeatType === 'brick') {
          drawX += (Math.abs(j) % 2 === 1) ? tileSize / 2 : 0;
        }
        
        ctx.drawImage(tileImage, drawX, drawY, tileSize, tileSize);
      }
    }
    
    if (showGrid) {
      ctx.strokeStyle = 'rgba(255,255,255,0.4)';
      ctx.lineWidth = 1 / zoom;
      
      for (let i = startTileX; i < startTileX + tilesX + 1; i++) {
        let lineX = i * tileSize + offsetPercentX * tileSize;
        ctx.beginPath();
        ctx.moveTo(lineX, startTileY * tileSize - tileSize);
        ctx.lineTo(lineX, (startTileY + tilesY + 1) * tileSize);
        ctx.stroke();
      }
      
      for (let j = startTileY; j < startTileY + tilesY + 1; j++) {
        let lineY = j * tileSize + offsetPercentY * tileSize;
        ctx.beginPath();
        ctx.moveTo(startTileX * tileSize - tileSize, lineY);
        ctx.lineTo((startTileX + tilesX + 1) * tileSize, lineY);
        ctx.stroke();
      }
    }
    
    if (seamlessTestMode) {
      drawSeamlessTest(tileSize);
    }
    
    if (gridOverlaySize > 0) {
      drawGridOverlay(tileSize);
    }
    
  } else {
    ctx.translate(els.canvas.width / 2, els.canvas.height / 2);
    
    const mockups = {
      phone: mockupImages.phone,
      ipad: mockupImages.ipad,
      tote: mockupImages.tote,
      bandana: mockupImages.bandana,
      bedspread: mockupImages.bedspread,
      mug: mockupImages.mug,
      bottle: mockupImages.bottle,
      sweatshirt: mockupImages.sweatshirt
    };
    
    if (mockups[viewMode]) {
      drawMockup(mockups[viewMode]);
    } else if (viewMode === 'fabric') {
      const maxSize = Math.min(els.canvas.width, els.canvas.height) * 0.6;
      const fabricWidth = maxSize * 0.95;
      const fabricHeight = fabricWidth * 0.8;
      
      ctx.save();
      roundedRect(ctx, -fabricWidth / 2, -fabricHeight / 2, fabricWidth, fabricHeight, 15);
      ctx.fillStyle = '#2a2a2a';
      ctx.fill();
      ctx.strokeStyle = '#444';
      ctx.lineWidth = 2;
      ctx.stroke();
      ctx.clip();
      
      drawPatternToContext(ctx, -fabricWidth / 2, -fabricHeight / 2, fabricWidth, fabricHeight, tileSize);
      ctx.restore();
    }
  }
  
  ctx.restore();
}

/* ==================== FILE LOADING ==================== */

function loadImage(file) {
  if (!file) return;
  
  showLoading(false, {
    message: 'Loading your pattern...',
    subtext: file ? `${file.name} (${Math.round(file.size / 1024)} KB)` : 'Processing image',
    showProgress: true,
    progress: 20
  });
  
  let prog = 20;
  const uploadInterval = setInterval(() => {
    prog += 12;
    if (prog <= 80) {
      updateLoadingProgress(prog, 'Loading your pattern...');
    }
  }, 120);
  
  const reader = new FileReader();
  
  reader.onload = (e) => {
    const img = new Image();
    
    img.onload = () => {
      clearInterval(uploadInterval);
      updateLoadingProgress(100, 'Complete!');
      
      tileImage = img;
      scale = Math.max(0.05, Math.min(5, 300 / tileImage.width));
      
      let sliderVal;
      if (scale <= 1.0) {
        sliderVal = Math.round(((scale - 0.05) / 0.95) * 50);
      } else {
        sliderVal = Math.round(50 + ((scale - 1.0) / 4.0) * 50);
      }
      
      els.patternScale.value = sliderVal;
      els.scaleValue.textContent = scale.toFixed(2) + '√ó';
      els.emptyState.classList.remove('visible');
      updateBackground();
      analyzePattern();
      els.patternInfo.classList.add('visible');
      draw();
      hideLoading();
    };
    
    img.onerror = () => {
      clearInterval(uploadInterval);
      hideLoading();
      alert('Failed to load image!');
    };
    
    img.src = e.target.result;
  };
  
  reader.readAsDataURL(file);
}

els.fileInput.addEventListener('change', (e) => loadImage(e.target.files[0]));

// Drag and drop
els.canvas.addEventListener('dragover', (e) => {
  e.preventDefault();
  els.canvas.style.opacity = '0.7';
});

els.canvas.addEventListener('dragleave', () => {
  els.canvas.style.opacity = '1';
});

els.canvas.addEventListener('drop', (e) => {
  e.preventDefault();
  els.canvas.style.opacity = '1';
  loadImage(e.dataTransfer.files[0]);
});

/* ==================== CANVAS PAN & ZOOM ==================== */

els.canvas.addEventListener('pointerdown', (e) => {
  if (!tileImage || (viewMode !== 'tile' && viewMode !== 'tile-grid')) return;
  isDragging = true;
  dragStartX = e.clientX - panX;
  dragStartY = e.clientY - panY;
  els.canvas.setPointerCapture(e.pointerId);
});

els.canvas.addEventListener('pointermove', (e) => {
  if (!isDragging || (viewMode !== 'tile' && viewMode !== 'tile-grid')) return;
  panX = e.clientX - dragStartX;
  panY = e.clientY - dragStartY;
  draw();
});

els.canvas.addEventListener('pointerup', () => isDragging = false);
els.canvas.addEventListener('pointerleave', () => isDragging = false);

// Mouse wheel zoom
els.canvas.addEventListener('wheel', (e) => {
  if (!tileImage) return;
  
  const rect = els.canvas.getBoundingClientRect();
  const mouseX = e.clientX - rect.left;
  const mouseY = e.clientY - rect.top;
  const edgeDeadZone = 80;
  
  const isInDeadZone = 
    mouseX < edgeDeadZone || 
    mouseX > rect.width - edgeDeadZone || 
    mouseY < edgeDeadZone || 
    mouseY > rect.height - edgeDeadZone;
  
  if (isInDeadZone) return;
  
  e.preventDefault();
  
  const zoomFactor = e.deltaY < 0 ? 1.1 : 0.9;
  
  let newZoom = Math.max(MIN_ZOOM, Math.min(MAX_ZOOM, zoom * zoomFactor));
  const scaleChange = newZoom - zoom;
  
  panX -= (mouseX - panX) * (scaleChange / zoom);
  panY -= (mouseY - panY) * (scaleChange / zoom);
  zoom = newZoom;
  
  const zoomPercent = Math.round(zoom * 100);
  
  let sliderVal;
  if (zoomPercent <= 100) {
    sliderVal = Math.round(((zoomPercent - 1) / 99) * 50);
  } else {
    sliderVal = Math.round(50 + ((zoomPercent - 100) / 700) * 50);
  }
  
  els.zoomSlider.value = sliderVal;
  els.zoomValue.textContent = zoomPercent + '%';
  draw();
}, { passive: false });

// Touch pinch zoom
let lastTouchDistance = 0;

els.canvas.addEventListener('touchstart', (e) => {
  if (e.touches.length === 2 && tileImage) {
    e.preventDefault();
    const touch1 = e.touches[0];
    const touch2 = e.touches[1];
    lastTouchDistance = Math.hypot(touch2.clientX - touch1.clientX, touch2.clientY - touch1.clientY);
  }
}, { passive: false });

els.canvas.addEventListener('touchmove', (e) => {
  if (e.touches.length === 2 && tileImage) {
    const rect = els.canvas.getBoundingClientRect();
    const touch1 = e.touches[0];
    const centerX = touch1.clientX - rect.left;
    const centerY = touch1.clientY - rect.top;
    const edgeDeadZone = 100;
    
    const isInDeadZone = 
      centerX < edgeDeadZone || 
      centerX > rect.width - edgeDeadZone || 
      centerY < edgeDeadZone || 
      centerY > rect.height - edgeDeadZone;
    
    if (isInDeadZone) return;
    
    e.preventDefault();
    const touch2 = e.touches[1];
    const currentDistance = Math.hypot(touch2.clientX - touch1.clientX, touch2.clientY - touch1.clientY);
    
    if (lastTouchDistance > 0) {
      const zoomFactor = currentDistance / lastTouchDistance;
      const rect = els.canvas.getBoundingClientRect();
      const centerX = ((touch1.clientX + touch2.clientX) / 2) - rect.left;
      const centerY = ((touch1.clientY + touch2.clientY) / 2) - rect.top;
      
      let newZoom = Math.max(MIN_ZOOM, Math.min(MAX_ZOOM, zoom * zoomFactor));
      const scaleChange = newZoom - zoom;
      
      panX -= (centerX - panX) * (scaleChange / zoom);
      panY -= (centerY - panY) * (scaleChange / zoom);
      zoom = newZoom;
      
      const zoomPercent = Math.round(zoom * 100);
      
      let sliderVal;
      if (zoomPercent <= 100) {
        sliderVal = Math.round(((zoomPercent - 1) / 99) * 50);
      } else {
        sliderVal = Math.round(50 + ((zoomPercent - 100) / 700) * 50);
      }
      
      els.zoomSlider.value = sliderVal;
      els.zoomValue.textContent = zoomPercent + '%';
      draw();
    }
    
    lastTouchDistance = currentDistance;
  }
}, { passive: false });

els.canvas.addEventListener('touchend', () => lastTouchDistance = 0);

/* ==================== CONTROL HANDLERS ==================== */

els.repeatType.addEventListener('change', (e) => {
  repeatType = e.target.value;
  draw();
});

els.viewMode.addEventListener('change', (e) => {
  viewMode = e.target.value;
  draw();
});

els.bgColor.addEventListener('change', (e) => {
  backgroundColor = e.target.value;
  updateBackground();
  draw();
});

els.patternScale.addEventListener('input', (e) => {
  const sliderVal = parseInt(e.target.value);
  
  if (sliderVal <= 50) {
    scale = 0.05 + (sliderVal / 50) * 0.95;
  } else {
    scale = 1.0 + ((sliderVal - 50) / 50) * 4.0;
  }
  
  els.scaleValue.textContent = scale.toFixed(2) + '√ó';
  draw();
});

els.patternScale.addEventListener('change', (e) => {
  triggerHaptic('selection');
  const sliderVal = parseInt(e.target.value);
  
  if (sliderVal <= 50) {
    scale = 0.05 + (sliderVal / 50) * 0.95;
  } else {
    scale = 1.0 + ((sliderVal - 50) / 50) * 4.0;
  }
  
  scale = scale >= 0.5 ? snap(scale * 100, 5) / 100 : snap(scale * 100, 1) / 100;
  
  let newSliderVal;
  if (scale <= 1.0) {
    newSliderVal = Math.round(((scale - 0.05) / 0.95) * 50);
  } else {
    newSliderVal = Math.round(50 + ((scale - 1.0) / 4.0) * 50);
  }
  
  els.patternScale.value = newSliderVal;
  els.scaleValue.textContent = scale.toFixed(2) + '√ó';
  draw();
});

els.zoomSlider.addEventListener('input', (e) => {
  const sliderVal = parseInt(e.target.value);
  
  if (sliderVal <= 50) {
    zoom = (1 + (sliderVal / 50) * 99) / 100;
  } else {
    zoom = (100 + ((sliderVal - 50) / 50) * 700) / 100;
  }
  
  els.zoomValue.textContent = Math.round(zoom * 100) + '%';
  draw();
});

els.zoomSlider.addEventListener('change', (e) => {
  triggerHaptic('selection');
  const sliderVal = parseInt(e.target.value);
  
  if (sliderVal <= 50) {
    zoom = (1 + (sliderVal / 50) * 99) / 100;
  } else {
    zoom = (100 + ((sliderVal - 50) / 50) * 700) / 100;
  }
  
  const zoomPercent = Math.round(zoom * 100);
  const snapped = zoomPercent <= 100 ? snap(zoomPercent, 1) : snap(zoomPercent, 5);
  zoom = snapped / 100;
  
  let newSliderVal;
  if (snapped <= 100) {
    newSliderVal = Math.round(((snapped - 1) / 99) * 50);
  } else {
    newSliderVal = Math.round(50 + ((snapped - 100) / 700) * 50);
  }
  
  els.zoomSlider.value = newSliderVal;
  els.zoomValue.textContent = snapped + '%';
  draw();
});

els.offsetX.addEventListener('input', (e) => {
  offsetPercentX = parseInt(e.target.value) / 100;
  els.offsetXValue.textContent = e.target.value + '%';
  draw();
});

els.offsetX.addEventListener('change', (e) => {
  triggerHaptic('selection');
  const snapped = snap(parseInt(e.target.value), 1);
  offsetPercentX = snapped / 100;
  els.offsetX.value = snapped;
  els.offsetXValue.textContent = snapped + '%';
  draw();
});

els.offsetY.addEventListener('input', (e) => {
  offsetPercentY = parseInt(e.target.value) / 100;
  els.offsetYValue.textContent = e.target.value + '%';
  draw();
});

els.offsetY.addEventListener('change', (e) => {
  triggerHaptic('selection');
  const snapped = snap(parseInt(e.target.value), 1);
  offsetPercentY = snapped / 100;
  els.offsetY.value = snapped;
  els.offsetYValue.textContent = snapped + '%';
  draw();
});

els.mockupZoom.addEventListener('input', (e) => {
  mockupZoom = parseInt(e.target.value) / 100;
  els.mockupZoomValue.textContent = e.target.value + '%';
  draw();
});

els.mockupRotate.addEventListener('input', (e) => {
  mockupRotate = parseInt(e.target.value);
  els.mockupRotateValue.textContent = e.target.value + '¬∞';
  draw();
});

draw();
</script>

<!-- Hidden visitor tracker - counts toward home page total -->

<img src="https://hits.sh/rud3boy.vercel.app.svg" alt="" style="display: none;" />
</body>
</html>